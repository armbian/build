BOOTSCRIPT="boot-rockchip.cmd:boot.cmd"
BOOTENV_FILE='rockchip-default.txt'

UBOOT_TARGET_MAP=";;$SRC/packages/blobs/rockchip/rk3288_boot.bin u-boot-rockchip-with-spl.bin"

UBOOT_USE_GCC='> 6.3'

BOOTDELAY=0

BOOTSOURCE=$MAINLINE_UBOOT_SOURCE
BOOTDIR=$MAINLINE_UBOOT_DIR
if [[ $BOARD == miqi ]]; then
BOOTBRANCH='tag:v2017.11'
else
BOOTBRANCH='tag:v2018.09'
fi

# We use v2018.03 for xt-q8l-v10 because v2018.05 does not work for this particular board (for unknown reasons)
# Other rk3288 boards seems to work fine with v2018.05
if [[ $BOARD == 'xt-q8l-v10' && $BOOTBRANCH == 'tag:v2018.05' ]]; then
    BOOTBRANCH='tag:v2018.03'
fi

SERIALCON=ttyS2

case $BRANCH in
	default)
	KERNELSOURCE='https://github.com/rockchip-linux/kernel.git'
	KERNELBRANCH='branch:release-4.4'
	KERNELPATCHDIR='rockchip-default'
	KERNELDIR='linux-rockchip'

	KERNEL_USE_GCC='> 7.0'
	;;

	next)
	KERNELSOURCE=$MAINLINE_KERNEL_SOURCE
	KERNELBRANCH='branch:linux-4.14.y'
	KERNELDIR=$MAINLINE_KERNEL_DIR

	KERNEL_USE_GCC='> 7.0'
	;;

	dev)
	KERNELSOURCE=$MAINLINE_KERNEL_SOURCE
	KERNELBRANCH='branch:linux-4.18.y'
	KERNELDIR=$MAINLINE_KERNEL_DIR

	KERNEL_USE_GCC='> 7.0'
	;;

esac

CPUMIN="600000"
CPUMAX="1900000"
GOVERNOR="ondemand"

write_uboot_platform()
{
	dd if=/dev/zero of=$2 bs=1k count=1023 seek=1 status=noxfer > /dev/null 2>&1
	dd if=$1/u-boot-rockchip-with-spl.bin of=$2 seek=64 conv=notrunc > /dev/null 2>&1
}

uboot_custom_postprocess()
{

	# xt-q8l-v10 requires the original DDR init blob because u-boot does not support LPDDR2 initialization
	# for rk3288 SoC (binary is in sources/rkbin-tools/rk32 path)
	# UPDATE 2018/09/22: changed u-boot config to use TPL and throw it away. This way we boot the SPL which does some 
	# more initial configurations, expecially pinmux for power hold, so reset works more reliably. Also u-boot image is
	# set to be at sector 0x200 on the eMMC/SD, so we burn it 0x200-0x40 because of the rockchip 0x40 sectors offset
	if [[ $BOARD == xt-q8l-v10 ]]; then
		tools/mkimage -n rk3288 -T rksd -d $SRC/cache/sources/rkbin-tools/rk32/rk3288_ddr_400MHz_v1.03.bin u-boot-rockchip-with-spl.bin
		cat spl/u-boot-spl-dtb.bin >> u-boot-rockchip-with-spl.bin
		dd if=u-boot-dtb.img of=u-boot-rockchip-with-spl.bin seek=$((0x200 - 0x40)) conv=notrunc
	else
		tools/mkimage -n rk3288 -T rksd -d spl/u-boot-spl-dtb.bin u-boot-rockchip-with-spl.bin
		cat u-boot-dtb.bin >> u-boot-rockchip-with-spl.bin
	fi

}

family_tweaks()
{
	if [[ $BOARD == tinkerboard ]]; then
		chroot $SDCARD /bin/bash -c "systemctl --no-reload enable tinker-bluetooth.service >/dev/null 2>&1"
		sed -i -e "/#load-module module-alsa-sink/r $SRC/packages/bsp/rockchip/pulseaudio.txt" $SDCARD/etc/pulse/default.pa >/dev/null 2>&1
	fi

	if [[ $BOARD == xt-q8l-v10 ]]; then
		echo "fdtfile=rk3288-xt-q8l-v10.dtb" >> $SDCARD/boot/armbianEnv.txt
		echo "extraargs=brcmfmac.alternative_fw_path=ap6330" >> $SDCARD/boot/armbianEnv.txt

		# AP6330 firmware, for xt-q8l-v10 taken directly from rkbin-tools
		# Beware: putting this here is a workaround because these firmware files won't
		# appear in armbian-firmware* deb packages!

                mkdir -p $SDCARD/lib/firmware/ap6330/brcm
                cp $SRC/cache/sources/rkbin-tools/firmware/bluetooth/bcm40183b2.hcd $SDCARD/lib/firmware/ap6330/brcm
                cp $SRC/cache/sources/rkbin-tools/firmware/wifi/fw_bcm4330.bin $SDCARD/lib/firmware/ap6330/brcm/brcmfmac4330-sdio.bin
                cp $SRC/cache/sources/rkbin-tools/firmware/wifi/fw_bcm4330_apsta.bin $SDCARD/lib/firmware/ap6330/brcm
                cp $SRC/cache/sources/rkbin-tools/firmware/wifi/nvram_AP6330.txt $SDCARD/lib/firmware/ap6330/brcm/brcmfmac4330-sdio.txt

                chroot $SDCARD /bin/bash -c "systemctl --no-reload enable ap6330-bluetooth.service >/dev/null 2>&1"

		# Avoid downloading new kernels and dtbs during update to prevent boot issues
		chroot $SDCARD /bin/bash -c "apt-mark hold linux-image-rockchip linux-dtb-rockchip"

	fi
}

family_tweaks_bsp()
{
		#Graphics and media
		mkdir -p $destination/etc/udev/rules.d
		mkdir -p $destination/usr/local/bin
		cp $SRC/packages/bsp/rockchip/hdmi.rules $destination/etc/udev/rules.d
		cp $SRC/packages/bsp/rockchip/50-hevc.rules $destination/etc/udev/rules.d
		cp $SRC/packages/bsp/rockchip/50-mali.rules $destination/etc/udev/rules.d
		cp $SRC/packages/bsp/rockchip/50-vpu.rules $destination/etc/udev/rules.d
		cp $SRC/packages/bsp/rockchip/60-media.rules $destination/etc/udev/rules.d
		install -m 755 $SRC/packages/bsp/rockchip/hdmi-hotplug $destination/usr/local/bin

		# Peripheral access for specific groups
		addgroup --system --quiet --gid 997 gpio
		addgroup --system --quiet --gid 998 i2c
		cp $SRC/packages/bsp/rockchip/70-gpio.rules $destination/etc/udev/rules.d
		cp $SRC/packages/bsp/rockchip/71-i2c.rules $destination/etc/udev/rules.d

		# Bluetooth
		install -m 755 $SRC/packages/bsp/rockchip/rtk_hciattach $destination/usr/bin
		install -m 755 $SRC/packages/bsp/rockchip/start_bt.sh $destination/usr/local/bin
		cp $SRC/packages/bsp/rockchip/tinker-bluetooth.service $destination/lib/systemd/system/

		# Sound
		cp $SRC/packages/bsp/rockchip/asound.conf $destination/etc/
		cp $SRC/packages/bsp/rockchip/89-pulseaudio-usb.rules $destination/etc/udev/rules.d

		# ap6330 bluetooth (required for xt-q8l-v10)
                cp $SRC/packages/bsp/rockchip/ap6330-bluetooth.service $destination/lib/systemd/system/

}
