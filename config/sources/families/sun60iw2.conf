#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

declare -g LINUXFAMILY="sun60iw2"
declare -g ARCH="arm64"
declare -g ATF_COMPILE='no'

case "${BRANCH}" in
    vendor)
        declare -g KERNEL_MAJOR_MINOR="5.15"
        declare -g KERNELSOURCE="${GITHUB_SOURCE}/radxa/kernel.git"
        declare -g KERNELBRANCH="branch:allwinner-aiot-linux-5.15"
        declare -g KERNELPATCHDIR="archive/sunxi-${KERNEL_MAJOR_MINOR}"
        declare -g LINUXCONFIG="linux-sun60i-${BRANCH}"
        declare -g ALLWINNER_BSP_SOURCE="${GITHUB_SOURCE}/radxa/allwinner-bsp"
        declare -g BSPBRANCH="branch:cubie-aiot-v1.4.6"
        declare -g ALLWINNER_DEVICE_SOURCE="${GITHUB_SOURCE}/radxa/allwinner-device"
        declare -g DEVICEBRANCH="branch:device-a733-v1.4.6"
        ;;
esac


function build_custom_uboot() {
    display_alert "Retrieving latest Radxa U-Boot from GitHub" "${BOARD}" "info"

    # Define GitHub Repository
    local GITHUB_REPO="radxa-pkg/u-boot-aw2501"
    local API_URL="https://api.github.com/repos/${GITHUB_REPO}/releases/latest"
    local DEB_VENDOR_BLOB=""

    # 1. Get the download URL for the latest .deb asset
    local DOWNLOAD_URL
    DOWNLOAD_URL=$(curl -sL --connect-timeout 30 --max-time 120 "${API_URL}" | \
        jq -r '.assets[].browser_download_url | select(endswith(".deb"))' | head -n 1)

    if [[ -z "${DOWNLOAD_URL}" ]]; then
        exit_with_error "Failed to find a .deb asset in the latest GitHub release for ${GITHUB_REPO}"
    fi

    # 2. Prepare temporary download location
    local DOWNLOAD_DIR
    DOWNLOAD_DIR=$(mktemp -d)
    local DEB_NAME
    DEB_NAME=$(basename "${DOWNLOAD_URL}")
    DEB_VENDOR_BLOB="${DOWNLOAD_DIR}/${DEB_NAME}"

    display_alert "Downloading ${DEB_NAME}..." "" "info"
    curl -sL --connect-timeout 30 --max-time 300 "${DOWNLOAD_URL}" -o "${DEB_VENDOR_BLOB}" || \
        exit_with_error "Download from GitHub failed"

    # 3. Standard Armbian build variables check
    [[ -z "${uboottempdir:-}" ]] && exit_with_error "uboottempdir is not set by caller"
    [[ -z "${uboot_name:-}" ]] && exit_with_error "uboot_name is not set by caller"

    # 4. Extract and Repackage
    local vendortmp
    vendortmp=$(mktemp -d)
    ( cd "${vendortmp}" && dpkg-deb -x "${DEB_VENDOR_BLOB}" . ) || {
        rm -rf "${vendortmp}" "${DOWNLOAD_DIR}"
        exit_with_error "Failed to extract vendor .deb: ${DEB_VENDOR_BLOB}"
    }

    mkdir -p "${uboottempdir}/usr/lib/${uboot_name}"

    local srcdir=""
    # Radxa package layout usually follows /usr/lib/u-boot/<BOARD_NAME>
    if [[ -d "${vendortmp}/usr/lib/u-boot/${BOARD}" ]]; then
        srcdir="${vendortmp}/usr/lib/u-boot/${BOARD}"
    fi
    
    if [[ -n "${srcdir}" ]]; then
        local required_files=("boot0_sdcard.bin" "boot0_ufs.bin" "boot_package.fex")
        local found_any=false

        for filename in "${required_files[@]}"; do
            local src_file="${srcdir}/${filename}"
            local dest_dir="${uboottempdir}/usr/lib/${uboot_name}/"

            if [[ -f "${src_file}" ]]; then
                if cp "${src_file}" "${dest_dir}"; then
                    display_alert "Successfully copied ${filename}" "${BOARD}" "info"
                    found_any=true
                else
                    display_alert "Failed to copy ${filename} to destination" "${BOARD}" "err"
                fi
            else
                display_alert "Required file missing from vendor package: ${filename}" "${BOARD}" "warn"
            fi
        done

        if [[ "${found_any}" == "false" ]]; then
	        rm -rf "${vendortmp}" "${DOWNLOAD_DIR}"
	        exit_with_error "Critical: No boot binaries were found in ${srcdir}"
        fi
    else
	    rm -rf "${vendortmp}" "${DOWNLOAD_DIR}"
	    exit_with_error "Vendor package layout not found for board: ${BOARD}"
    fi

    # 5. Cleanup temporary files
    rm -rf "${vendortmp}" "${DOWNLOAD_DIR}"

    declare -g EXTENSION_BUILT_UBOOT="yes"

    return 0
}


function kernel_copy_extra_sources__radxa_allwinner_bsp() {
    display_alert "$BOARD" "Retrieving latest Radxa Allwinner BSP (Board Support Package)" "info"

    allwinner_bsp_git_bare_tree="${SRC}/cache/git-bare/allwinner-bsp"
    declare allwinner_bsp_git_bare_tree_done_marker="${allwinner_bsp_git_bare_tree}/.git/armbian-bare-tree-done"

    if [ ! -d "${allwinner_bsp_git_bare_tree}" ] || [ ! -f "${allwinner_bsp_git_bare_tree_done_marker}" ]; then
        if [[ -d "${allwinner_bsp_git_bare_tree}" ]]; then
            rm -rf "${allwinner_bsp_git_bare_tree}"
        fi

        run_host_command_logged git clone --tags --no-checkout \
            "${ALLWINNER_BSP_SOURCE}" "${allwinner_bsp_git_bare_tree}"

        touch "${allwinner_bsp_git_bare_tree_done_marker}"
    fi

    git_ensure_safe_directory "${allwinner_bsp_git_bare_tree}"

    GIT_FIXED_WORKDIR="${LINUXSOURCEDIR}/bsp" \
        GIT_BARE_REPO_FOR_WORKTREE="${allwinner_bsp_git_bare_tree}" \
        GIT_BARE_REPO_INITIAL_BRANCH="${BSPBRANCH#*:}" \
        fetch_from_repo "${ALLWINNER_BSP_SOURCE}" "allwinner_bsp:${KERNEL_MAJOR_MINOR}" "${BSPBRANCH}" "yes"

    local expected_dir="${kernel_work_dir}/bsp"
    local wait_count=0
    while [[ ! -d "${expected_dir}/configs" ]] && [[ $wait_count -lt 60 ]]; do
        display_alert "Waiting for BSP files to appear" "Wait time: $((wait_count * 2))s" "info"
        sleep 2
        wait_count=$((wait_count + 1))
    done
    
    local CURRENT_BSP_HASH=$(cd "${expected_dir}" && git log -n 1 --abbrev=10 --pretty=format:"%h")
    
    local PATCH_ARCHIVE_DIR="${SRC}/patch/kernel/archive/sunxi-5.15"
	local EXISTING_BSP_FILE=""
	local EXISTING_BSP_HASH=""
	if compgen -G "${PATCH_ARCHIVE_DIR}/0004-Add-BSP-support-files-"*.patch > /dev/null; then
    	EXISTING_BSP_FILE=$(basename "$(ls "${PATCH_ARCHIVE_DIR}/0004-Add-BSP-support-files-"*.patch 2>/dev/null | head -n 1)")
    	EXISTING_BSP_HASH=$(echo "${EXISTING_BSP_FILE}" | grep -oP 'files-\K[a-f0-9]+(?=\.patch)')
	fi
    
    local PATCH_TARGET_DIR="${SRC}/cache/patch/radxa-bsp"
    mkdir -p "${PATCH_TARGET_DIR}"
    
    local PATCH_NAME="0004-Add-BSP-support-files-${CURRENT_BSP_HASH}.patch"
    local FULL_PATCH_PATH="${PATCH_TARGET_DIR}/${PATCH_NAME}"

    if [[ -f "${FULL_PATCH_PATH}" ]] || [[ -n "${CURRENT_BSP_HASH}" && "${CURRENT_BSP_HASH}" == "${EXISTING_BSP_HASH}" ]]; then
        display_alert "$BOARD" "BSP patch for hash ${CURRENT_BSP_HASH} exists. Skipping." "info"
        return 0
    fi
    
    display_alert "$BOARD" "New remote state detected (${CURRENT_BSP_HASH}). Updated patches stored in ${FULL_PATCH_PATH}" "info"
    rm -f "${PATCH_TARGET_DIR}/0003-BSP-Autogen-File.patch"
    rm -f "${PATCH_TARGET_DIR}"/0004-Add-BSP-support-files-*.patch

    if [[ -d "${expected_dir}" ]]; then
        run_host_command_logged cp "${expected_dir}"/configs/linux-5.15/*.dtsi "${kernel_work_dir}"/arch/arm64/boot/dts/allwinner
        run_host_command_logged cp -r "${expected_dir}"/include/dt-bindings/. "${kernel_work_dir}"/include/dt-bindings

        local insert_text="\
export BSP_TOP := bsp/\n\
export LICHEE_KERN_DIR := ./\n\
export KBUILD_DEFCONFIG := bsp.config\n\
"
        sed -i "/NAME = Trick or Treat/a\\
${insert_text}" "${kernel_work_dir}/Makefile"

		local bsp_patch_file="${PATCH_TARGET_DIR}/0003-BSP-Autogen-File.patch"
        local autogen_content="#define AW_BSP_VERSION \"${CURRENT_BSP_HASH}, $(date "+%Y-%m-%d %H:%M:%S"), RadxaOS SDK\""
        mkdir -p "${expected_dir}/include"
        echo "${autogen_content}" > "${expected_dir}/include/sunxi-autogen.h"
        
        display_alert "$BOARD" "Generating 0003-BSP-Autogen-File.patch" "info"
        (
        	{  
            	echo "--- /dev/null"
            	echo "+++ b/bsp/include/sunxi-autogen.h"
            	echo "@@ -0,0 +1 @@"
            	echo "+${autogen_content}"  
        	} > "${bsp_patch_file}"
        	
        	display_alert "$BOARD" "Generating ${PATCH_NAME}" "info"
            cd "${kernel_work_dir}" || exit_with_error "Failed to cd to kernel_work_dir"
            git config user.email "support@armbian.com"
            git config user.name "Armbian Builder"

            git add Makefile
            git add arch/arm64/boot/dts/allwinner/*.dtsi
            git add include/dt-bindings/
            
            git commit -m "Add BSP support files ${CURRENT_BSP_HASH}"
            git format-patch -1 --stdout > "${FULL_PATCH_PATH}"
            
            git reset --hard HEAD~1
            git clean -fd
        ) || exit_with_error "BSP patch generation failed"
    else
        display_alert "Radxa Allwinner BSP not found." "${BOARD}" "err"
    fi
}


function kernel_copy_extra_sources__radxa_allwinner_device() {
    display_alert "$BOARD" "Retrieving latest Radxa Allwinner Device" "info"
    
    local REMOTE_BRANCH_NAME="${DEVICEBRANCH#*:}"
    local CURRENT_REMOTE_HASH=$(git ls-remote "${ALLWINNER_DEVICE_SOURCE}" "refs/heads/${REMOTE_BRANCH_NAME}" | awk '{print substr($1,1,10)}')
    
    if [[ -z "${CURRENT_REMOTE_HASH}" ]]; then
        display_alert "$BOARD" "Could not retrieve remote hash for ${REMOTE_BRANCH_NAME}. Proceeding with caution." "err"
    fi

    local PATCH_ARCHIVE_DIR="${SRC}/patch/kernel/archive/sunxi-5.15"
    local EXISTING_PATCH_FILE=""
    local EXISTING_PATCH_HASH=""
    if compgen -G "${PATCH_ARCHIVE_DIR}/0005-Add-Allwinner-Device-a733-"*.patch > /dev/null; then
        EXISTING_PATCH_FILE=$(basename "$(ls "${PATCH_ARCHIVE_DIR}/0005-Add-Allwinner-Device-a733-"*.patch 2>/dev/null | head -n 1)")
        EXISTING_PATCH_HASH=$(echo "${EXISTING_PATCH_FILE}" | grep -oP 'a733-\K[a-f0-9]+(?=\.patch)')
    fi

    local PATCH_TARGET_DIR="${SRC}/cache/patch/radxa-device"
    mkdir -p "${PATCH_TARGET_DIR}"
    
    local PATCH_NAME="0005-Add-Allwinner-Device-a733-${CURRENT_REMOTE_HASH}.patch"
    local FULL_PATCH_PATH="${PATCH_TARGET_DIR}/${PATCH_NAME}"

    if [[ -f "${FULL_PATCH_PATH}" ]] || [[ -n "${CURRENT_REMOTE_HASH}" && "${CURRENT_REMOTE_HASH}" == "${EXISTING_PATCH_HASH}" ]]; then
        display_alert "$BOARD" "Device patch for hash ${CURRENT_REMOTE_HASH} exists. Skipping." "info"
        return 0
    fi

    display_alert "$BOARD" "New remote state detected (${CURRENT_REMOTE_HASH}). Updated patch stored in ${FULL_PATCH_PATH}" "info"
    rm -f "${PATCH_TARGET_DIR}"/0005-Add-Allwinner-Device-a733*.patch

    allwinner_device_git_bare_tree="${SRC}/cache/git-bare/allwinner-device"
    declare allwinner_device_git_bare_tree_done_marker="${allwinner_device_git_bare_tree}/.git/armbian-bare-tree-done"

    if [ ! -d "${allwinner_device_git_bare_tree}" ] || [ ! -f "${allwinner_device_git_bare_tree_done_marker}" ]; then
        if [[ -d "${allwinner_device_git_bare_tree}" ]]; then
            rm -rf "${allwinner_device_git_bare_tree}"
        fi
        run_host_command_logged git clone --tags --no-checkout \
            "${ALLWINNER_DEVICE_SOURCE}" "${allwinner_device_git_bare_tree}"
        touch "${allwinner_device_git_bare_tree_done_marker}"
    fi

    git_ensure_safe_directory "${allwinner_device_git_bare_tree}"

    GIT_FIXED_WORKDIR="allwinner-device" \
        GIT_BARE_REPO_FOR_WORKTREE="${allwinner_device_git_bare_tree}" \
        GIT_BARE_REPO_INITIAL_BRANCH="${REMOTE_BRANCH_NAME}" \
        fetch_from_repo "${ALLWINNER_DEVICE_SOURCE}" "allwinner_device:${KERNEL_MAJOR_MINOR}" "${DEVICEBRANCH}" "yes"
    
    local expected_dir="${SRC}/cache/sources/allwinner-device"
    
    local wait_count=0
    while [[ ! -d "${expected_dir}/configs" ]] && [[ $wait_count -lt 60 ]]; do
    display_alert "Waiting for Device files" "Wait time: $((wait_count * 2))s" "info"
        sleep 2
        wait_count=$((wait_count + 1))
    done
    
    if [[ -d "${expected_dir}" ]]; then
        run_host_command_logged cp "${expected_dir}/configs/cubie_a7a/linux-5.15/board.dts" "${kernel_work_dir}/arch/arm64/boot/dts/allwinner/sun60i-a733-cubie-a7a.dts"
        run_host_command_logged cp "${expected_dir}/configs/cubie_a7s/linux-5.15/board.dts" "${kernel_work_dir}/arch/arm64/boot/dts/allwinner/sun60i-a733-cubie-a7s.dts"
        run_host_command_logged cp "${expected_dir}/configs/cubie_a7z/linux-5.15/board.dts" "${kernel_work_dir}/arch/arm64/boot/dts/allwinner/sun60i-a733-cubie-a7z.dts"
        run_host_command_logged cp "${expected_dir}/configs/default/linux-5.15/bsp_defconfig" "${kernel_work_dir}/arch/arm64/configs/bsp.config"
        
        display_alert "$BOARD" "Generating ${PATCH_NAME}" "info"
        (
            cd "${kernel_work_dir}" || exit_with_error "Failed to cd to kernel_work_dir"
            git config user.email "support@armbian.com"
            git config user.name "Armbian Builder"
            git add .
            git commit -m "Add Allwinner Device a733 ${CURRENT_REMOTE_HASH}"
            git format-patch -1 --stdout > "${FULL_PATCH_PATH}"
            
            git reset --hard HEAD~1
            git clean -fd
        ) || exit_with_error "Device patch generation failed"
    else
        display_alert "Radxa Allwinner Device not found." "${BOARD}" "err"
    fi
}

function write_uboot_platform() {
    local SCRIPT_DIR="$1"
    local DEVICE="$2"

    dd conv=notrunc,fsync status=none if="$SCRIPT_DIR/boot0_sdcard.bin" of="$DEVICE" bs=512 seek=256
    dd conv=notrunc,fsync status=none if="$SCRIPT_DIR/boot0_ufs.bin" of="$DEVICE" bs=512 seek=2064
    dd conv=notrunc,fsync status=none if="$SCRIPT_DIR/boot_package.fex" of="$DEVICE" bs=512 seek=24576
    sync "${DEVICE}"
    
    sfdisk --part-label "$DEVICE" 1 "primary"
}
