#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2026 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

declare -g LINUXFAMILY="cix-p1"
declare -g ARCH="arm64"
declare -g BOOTCONFIG="none"
declare -g UEFI_GRUB_TIMEOUT=3
declare -g SERIALCON="" # Disable automatic console= parameter additions

# Current & Edge based on Entropis Linux Kernel <3
case $BRANCH in

	vendor)
		declare -g KERNEL_MAJOR_MINOR="6.6" # Major and minor versions of this kernel.
		declare -g LINUXCONFIG="linux-${LINUXFAMILY}-${BRANCH}"
		KERNELSOURCE='https://github.com/armbian/linux-cix.git'
		KERNELBRANCH='branch:cix-6.6-2025q4'
		KERNELPATCHDIR='cix-2025-Q4'
		declare -g INSTALL_ARMBIAN_FIRMWARE=yes
		declare -g -i KERNEL_GIT_CACHE_TTL=120 # 2 minutes; this is a high-traffic repo
		enable_extension "grub"
		declare -g GRUB_CMDLINE_LINUX_DEFAULT="loglevel=4 kasan=off video=efifb:off arm-smmu-v3.disable_bypass=0 cma=640M rootwait rw linlon-dp.enable_render=0" # linlon-dp.enable_render=0 for Panthor, video=efifb:off to workaround fb handover conflict
		declare -g EXTRAWIFI="no"
		# Disable boot logo/splash parameters that grub extension adds
		declare -g BOOT_LOGO="no"
		;;
	current)
		declare -g KERNEL_MAJOR_MINOR="6.18"
		declare -g LINUXCONFIG="linux-${LINUXFAMILY}-${BRANCH}"
		KERNELSOURCE='https://github.com/Sky1-Linux/linux.git'
		KERNELBRANCH='branch:main'
		KERNELPATCHDIR='sky1-linux-6.18'
		enable_extension "grub"
		declare -g INSTALL_ARMBIAN_FIRMWARE=no # Use sky1-firmware instead
		declare -g GRUB_CMDLINE_LINUX_DEFAULT="efi=noruntime clk_ignore_unused linlon_dp.enable_fb=1 nowatchdog watchdog_dev.handle_boot_enabled=0"
		declare -g EXTRAWIFI="no"
		# Disable boot logo/splash parameters that grub extension adds
		declare -g BOOT_LOGO="no"
		;;
	edge)
		declare -g KERNEL_MAJOR_MINOR="6.19"
		declare -g LINUXCONFIG="linux-${LINUXFAMILY}-${BRANCH}"
		KERNELSOURCE='https://github.com/Sky1-Linux/linux.git'
		KERNELBRANCH='branch:latest'
		KERNELPATCHDIR='sky1-linux-6.19'
		declare -g INSTALL_ARMBIAN_FIRMWARE=no # Use sky1-firmware instead
		enable_extension "grub"
		declare -g GRUB_CMDLINE_LINUX_DEFAULT="efi=noruntime clk_ignore_unused linlon_dp.enable_fb=1 nowatchdog watchdog_dev.handle_boot_enabled=0"
		declare -g EXTRAWIFI="no"
		# Disable boot logo/splash parameters that grub extension adds
		declare -g BOOT_LOGO="no"
		;;

esac

# Custom kernel config hook to handle firmware
function custom_kernel_config__cix_p1_firmware() {
	if [[ -f .config ]]; then
		display_alert "$BOARD" "Disabling embedded firmware (will be loaded at runtime)" "info"
		# Disable CONFIG_EXTRA_FIRMWARE - firmware will be loaded at runtime from sky1-firmware package
		kernel_config_modifying_hashes+=("CONFIG_EXTRA_FIRMWARE=\"\"")
		run_kernel_make_long_running olddefconfig
	fi
}

# Family tweaks: Install Sky1 firmware for current and edge branches
family_tweaks() {
	if [[ "${BRANCH}" == "current" ]] || [[ "${BRANCH}" == "edge" ]]; then
		display_alert "Setting up Sky1 Linux repository" "${BRANCH}" "info"

		# Download and add repository key
		display_alert "Downloading Sky1 repository key" "" "info"
		run_host_command_logged wget -qO "${SDCARD}"/usr/share/keyrings/sky1-linux.asc https://sky1-linux.github.io/apt/key.gpg

		# Add repository
		display_alert "Adding Sky1 repository" "" "info"
		cat <<- SKY1_REPO > "${SDCARD}"/etc/apt/sources.list.d/sky1-linux.list
			deb [signed-by=/usr/share/keyrings/sky1-linux.asc] https://sky1-linux.github.io/apt sid main non-free-firmware
		SKY1_REPO

		# Restrict repository to only sky1-firmware package
		display_alert "Restricting Sky1 repository to sky1-firmware package" "" "info"
		cat <<- SKY1_PREFS > "${SDCARD}"/etc/apt/preferences.d/sky1-linux-pin
			# Block all packages from Sky1 repository by default
			Package: *
			Pin: origin sky1-linux.github.io
			Pin-Priority: -1

			# Allow only sky1-firmware package
			Package: sky1-firmware
			Pin: origin sky1-linux.github.io
			Pin-Priority: 500
		SKY1_PREFS

		# Update package lists
		display_alert "Updating package lists" "apt update" "info"
		chroot_sdcard_apt_get_update

		# Install Sky1 firmware package
		display_alert "Installing Sky1 firmware" "sky1-firmware" "info"
		chroot_sdcard_apt_get_install sky1-firmware

		display_alert "Installing Mediatek firmware" "sky1-firmware" "info"
		chroot_sdcard_apt_get_install firmware-mediatek # Install Mediatek firmware for WiFi and Bluetooth (used on MS-R1)

		display_alert "Sky1 firmware installation" "completed" "info"
	fi
}

# Override configure_grub to prevent unwanted cmdline modifications
configure_grub() {
	display_alert "Extension: grub: Configuring GRUB" "UEFI GRUB (cix-p1 override)" "info"

	# Enable Armbian Wallpaper on GRUB
	if [[ "${VENDOR}" == Armbian ]]; then
		display_alert "Extension: grub: Enabling" "Armbian Wallpaper on GRUB" "info"
		mkdir -p "${MOUNT}"/usr/share/desktop-base/
		cat <<- grubWallpaper >> "${MOUNT}"/usr/share/desktop-base/grub_background.sh
			WALLPAPER=/usr/share/images/grub/wallpaper.png
			COLOR_NORMAL=white/black
			COLOR_HIGHLIGHT=black/white
		grubWallpaper
		run_host_command_logged chmod -v +x "${MOUNT}"/usr/share/desktop-base/grub_background.sh
	fi

	# Write GRUB config WITHOUT modifying GRUB_CMDLINE_LINUX_DEFAULT
	display_alert "Extension: grub: GRUB EFI kernel cmdline" "cmdline '${GRUB_CMDLINE_LINUX_DEFAULT}' distro=${UEFI_GRUB_DISTRO_NAME} timeout=${UEFI_GRUB_TIMEOUT}" ""
	cat <<- grubCfgFrag >> "${MOUNT}"/etc/default/grub.d/98-armbian.cfg
		GRUB_CMDLINE_LINUX_DEFAULT="${GRUB_CMDLINE_LINUX_DEFAULT}"
		GRUB_TIMEOUT_STYLE=menu
		GRUB_TIMEOUT=${UEFI_GRUB_TIMEOUT}
		GRUB_DISTRIBUTOR="${UEFI_GRUB_DISTRO_NAME}"
		GRUB_DISABLE_SUBMENU=y
		GRUB_DISABLE_OS_PROBER=false
		GRUB_FONT="/usr/share/grub/unicode.pf2"
		GRUB_GFXPAYLOAD=keep
		GRUB_DISABLE_UUID=false
		GRUB_DISABLE_LINUX_UUID=false
	grubCfgFrag

	if [[ "a${UEFI_GRUB_DISABLE_OS_PROBER}" != "a" ]]; then
		cat <<- grubCfgFragHostSide >> "${MOUNT}"/etc/default/grub.d/98-armbian.cfg
			GRUB_DISABLE_OS_PROBER=${UEFI_GRUB_DISABLE_OS_PROBER}
		grubCfgFragHostSide
	fi

	if [[ "a${UEFI_GRUB_TERMINAL}" != "a" ]]; then
		cat <<- grubCfgFragTerminal >> "${MOUNT}"/etc/default/grub.d/98-armbian.cfg
			GRUB_TERMINAL="${UEFI_GRUB_TERMINAL}"
		grubCfgFragTerminal
	fi
}
