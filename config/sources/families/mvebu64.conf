#!/bin/bash
#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2023 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/

ARCH=arm64
BOOTDELAY=1
BOOTPATCHDIR="u-boot-mvebu64"
KERNEL_IMAGE_TYPE=Image

# Use mainline ATF
ATFSOURCE='https://github.com/ARM-software/arm-trusted-firmware'
ATFDIR='arm-trusted-firmware-mvebu'
ATFBRANCH='tag:v2.10'
ATF_COMPILER='aarch64-linux-gnu-'
ATF_USE_GCC='> 8.0'
ATFPLAT="a3700"

case $BRANCH in

	current)
		KERNEL_MAJOR_MINOR="6.6"
		KERNELPATCHDIR='mvebu64-current'
		LINUXFAMILY=mvebu64
		LINUXCONFIG='linux-mvebu64-current'
	;;

	edge)
		KERNEL_MAJOR_MINOR="6.12"
		KERNELPATCHDIR='mvebu64-edge'
		LINUXFAMILY=mvebu64
		LINUXCONFIG='linux-mvebu64-edge'
	;;

esac

# Board-specific settings
CPUMIN=300000
CPUMAX=1400000
GOVERNOR=ondemand

# Boot script
BOOTSCRIPT="boot-mvebu.cmd:boot.cmd"
BOOTENV_FILE="mvebu.txt"

# U-Boot settings
BOOTSOURCE='https://github.com/u-boot/u-boot'
BOOTDIR='u-boot-mvebu'
BOOTBRANCH='tag:v2024.01'

# Empty UBOOT_TARGET_MAP - let Armbian use defaults
UBOOT_TARGET_MAP=""

BOOTDELAY=3
BOOTPATCHDIR="u-boot-mvebu64"

UBOOT_USE_GCC='> 8.0'
UBOOT_COMPILER='aarch64-linux-gnu-'

# Serialcon
SERIALCON="ttyS0:115200n8"

# Modules to load
MODULES="ahci mvneta mvpp2 sata_mv"
MODULES_CURRENT="ahci mvneta mvpp2 sata_mv"

# Family specific tweaks
family_tweaks() {
	:
}

# Family specific tweaks for BSP
family_tweaks_bsp() {
	:
}

# Write U-Boot to image
write_uboot_platform() {
	# For mvebu64 boards, U-Boot is typically written to a specific offset
	# MOCHAbin uses similar boot process to ESPRESSObin
	
	# Check if we have u-boot files
	if [[ -f $1/u-boot.bin ]]; then
		display_alert "Installing U-Boot to image" "u-boot.bin" "info"
		# Write u-boot to the image at offset 0
		# For Armada 3700/7040, the bootloader goes at the beginning
		dd if=$1/u-boot.bin of=$2 bs=512 seek=1 conv=notrunc status=none >/dev/null 2>&1 || true
	elif [[ -f $1/u-boot-spl.kwb ]]; then
		display_alert "Installing U-Boot SPL to image" "u-boot-spl.kwb" "info"
		dd if=$1/u-boot-spl.kwb of=$2 bs=512 seek=1 conv=notrunc status=none >/dev/null 2>&1 || true
	else
		display_alert "No U-Boot files found" "skipping bootloader installation" "wrn"
		# This is OK - we can use existing bootloader on the board
		return 0
	fi
}

# Setup for writing u-boot
setup_write_uboot_platform() {
	# Nothing special needed for mvebu64
	:
}
