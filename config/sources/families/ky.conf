#
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (c) 2013-2024 Igor Pecovnik, igor@armbian.com
#
# This file is a part of the Armbian Build Framework
# https://github.com/armbian/build/
#

declare -g ARCH="riscv64"
declare -g LINUXFAMILY="ky"
declare -g GOVERNOR="performance"

# U-Boot
declare -g BOOTSOURCE="https://github.com/orangepi-xunlong/u-boot-orangepi.git"
declare -g BOOTBRANCH="${BOOTBRANCH_BOARD:-"branch:v2022.10-ky"}"
declare -g BOOTDIR='u-boot-ky'
declare -g BOOTPATCHDIR="${BOOTPATCHDIR:-"ky"}"
declare -g UBOOT_TARGET_MAP=";;bootinfo_sd.bin bootinfo_emmc.bin bootinfo_spinor.bin FSBL.bin u-boot-env-default.bin u-boot-opensbi.itb"
declare -g BOOTCONFIG="x1_defconfig" # Boot with OrangePi RV2/X1 config

# Linux
case "${BRANCH}" in
	current)
		declare -g KERNELSOURCE="https://github.com/orangepi-xunlong/linux-orangepi.git"
		declare -g KERNELBRANCH="branch:orange-pi-6.6-ky"
		declare -g EXTRAWIFI="no" # WiFi drivers are already included in the kernel
		declare -g KERNEL_MAJOR_MINOR="6.6"
		declare -g LINUXCONFIG="linux-${LINUXFAMILY}-current"
		;;
	edge)
		declare -g KERNELSOURCE="https://github.com/orangepi-xunlong/linux-orangepi.git"
		declare -g KERNELBRANCH="branch:orange-pi-6.6-ky"
		declare -g EXTRAWIFI="no" # WiFi drivers are already included in the kernel
		declare -g KERNEL_MAJOR_MINOR="6.6"
		declare -g LINUXCONFIG="linux-${LINUXFAMILY}-edge"
		;;
esac

function custom_kernel_config__ky_k1_firmware() {
	if [[ -f .config ]]; then
		# check $kernel_work_dir is set and exists, or bail
		[[ -z "${kernel_work_dir}" ]] && exit_with_error "kernel_work_dir is not set"
		[[ ! -d "${kernel_work_dir}" ]] && exit_with_error "kernel_work_dir does not exist: ${kernel_work_dir}"
		display_alert "$BOARD" "Adding boot firmware" "info"
		mkdir -pv "${kernel_work_dir}/firmware"
		cp -fv "$SRC/packages/blobs/riscv64/ky/esos.elf" "${kernel_work_dir}/firmware"
	fi
}

pre_prepare_partitions() {
	declare -g OFFSET="30"
	declare -g IMAGE_PARTITION_TABLE="msdos"
}

write_uboot_platform() {
	local device=${2}
	if [[ -b "${device}boot0" ]]; then
		echo 0 > /sys/block/${device##*/}boot0/force_ro
		dd if=${1}/bootinfo_emmc.bin of=${device}boot0 >/dev/null 2>&1 && sync
		dd if=${1}/FSBL.bin of=${device}boot0 seek=512 bs=1 >/dev/null 2>&1 && sync
		echo 1 > /sys/block/${device##*/}boot0/force_ro
	fi

	dd if=$1/bootinfo_sd.bin of=$2 seek=0 conv=notrunc status=none >/dev/null 2>&1
	dd if=$1/FSBL.bin of=$2 seek=256 conv=notrunc status=none >/dev/null 2>&1
	dd if=$1/u-boot-env-default.bin of=$2 seek=768 conv=notrunc status=none >/dev/null 2>&1
	dd if=$1/u-boot-opensbi.itb of=$2 seek=1664 conv=notrunc status=none >/dev/null 2>&1
}

write_uboot_platform_mtd() {
	if [[ -b /dev/mtdblock0 ]]; then
		dd if=$1/bootinfo_spinor.bin of=/dev/mtdblock0 >/dev/null 2>&1 && sync
		dd if=$1/FSBL.bin of=/dev/mtdblock2 seek=0 bs=1 >/dev/null 2>&1 && sync
		dd if=$1/u-boot-env-default.bin of=/dev/mtdblock3 seek=0 bs=1 >/dev/null 2>&1 && sync
		dd if=$1/u-boot-opensbi.itb of=/dev/mtdblock5 seek=0 bs=1K >/dev/null 2>&1 && sync
	fi
}

function post_family_tweaks_bsp__ky_extras() {
	display_alert "$BOARD" "Installing KY platform BSP extras" "info"

	run_host_command_logged mkdir -pv "${destination}"/etc/modules-load.d
	run_host_command_logged mkdir -pv "${destination}"/opt/ky

	# Install basic utilities for RISC-V platform
	if [[ -f "${SRC}/packages/bsp/ky/setup.sh" ]]; then
		run_host_command_logged cp -v "${SRC}/packages/bsp/ky/setup.sh" "${destination}"/opt/ky/
		run_host_command_logged chmod +x "${destination}"/opt/ky/setup.sh
	fi

	# Configure pulseaudio for proper audio handling
	if [[ $BUILD_DESKTOP == yes ]]; then
		run_host_command_logged mkdir -pv "${destination}"/etc/pulse
		cat >> "${destination}"/etc/pulse/default.pa.d/90-ky-audio.pa << 'EOF'
# KY platform audio configuration
load-module module-alsa-sink device=hw:0,0 sink_name=HDMI-Playback sink_properties="device.description='HDMI Audio'"
load-module module-alsa-sink device=hw:1,0 sink_name=AudioCodec-Playback sink_properties="device.description='Audio Codec'"
set-default-sink HDMI-Playback
EOF
	fi
}