source "${BASH_SOURCE%/*}/include/fenix.inc"

UBOOT_TARGET_MAP=";;idbloader.img uboot.img trust.img"
SERIALCON='ttyFIQ0:1500000'

uboot_custom_postprocess()
{
	rm -rf uboot.img trust.img MiniLoaderAll.bin MiniLoaderAll_spinor.bin u-boot-spi.bin
	local UBOOT_LOAD_ADDR=`sed -n "/CONFIG_SYS_TEXT_BASE=/s/CONFIG_SYS_TEXT_BASE=//p" include/autoconf.mk|tr -d '\r'`
	loaderimage --pack --uboot ./u-boot.bin uboot.img ${UBOOT_LOAD_ADDR}
	rm u-boot.img u-boot-dtb.img

	tools/mkimage -n rk3399 -T rksd -d $SRC/cache/sources/khadas-blobs/edge/rk3399_ddr.bin idbloader.img
	cat $SRC/cache/sources/khadas-blobs/edge/rk3399miniloaderall.bin >> idbloader.img

	cd $SRC/cache/sources/khadas-blobs/edge/
	trust_merger  RK3399TRUST.ini
	cd -
	mv $SRC/cache/sources/khadas-blobs/edge/trust.img ./trust.img
}

write_uboot_platform()
{
	dd if=$1/idbloader.img of=$2 seek=64 conv=notrunc > /dev/null 2>&1
	dd if=$1/uboot.img of=$2 seek=16384 conv=notrunc > /dev/null 2>&1
	dd if=$1/trust.img of=$2 seek=24576 conv=notrunc > /dev/null 2>&1
}
