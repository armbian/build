#Texas Instruments AM62 dual core 1GB USB2 DDR4

BOARD_NAME="PocketBeagle 2"
BOARDFAMILY="k3"
BOARD_MAINTAINER="Grippy98"
BOOTCONFIG="am6232_pocketbeagle2_a53_defconfig"
BOOTFS_TYPE="fat"
TIBOOT3_BOOTCONFIG="am6232_pocketbeagle2_r5_defconfig"
TIBOOT3_FILE="tiboot3-am62x-hs-fs-evm.bin"
DEFAULT_CONSOLE="serial"
KERNEL_TARGET="edge"
KERNEL_TEST_TARGET="edge"
SERIALCON="ttyS2"
ATF_BOARD="lite"
SRC_EXTLINUX="yes"
SRC_CMDLINE="root=/dev/mmcblk1p2 rootwait console=ttyS2,115200n8"
BOOT_FDT_FILE="ti/k3-am6232-pocketbeagle2.dtb"
OPTEE_PLATFORM="k3-am62x"

# USB Gadget
function post_family_tweaks_bsp__pocketbeagle2_firmware() {
	display_alert "Setup USB Gadget for ${BOARD}" "${RELEASE}" "warn"

	# USB Gadget Network service
	mkdir -p $destination/usr/local/bin/
	mkdir -p $destination/usr/lib/systemd/system/
	mkdir -p $destination/etc/initramfs-tools/scripts/init-bottom/
	# The service expects the name setup-usbgadget-network.sh. Depending on the board vendor, the
	# usbgadget configuration they would like can be wildly different. However, the same service
	# will work fine for almost all cases. So better to rename file rather than modifying the service.
	install -Dm755 $SRC/packages/bsp/usb-gadget-network/setup-usbgadget-network-multi.sh $destination/usr/local/bin/setup-usbgadget-network.sh ||
		exit_with_error "Failed to install USB gadget setup script"
	install -Dm755 $SRC/packages/bsp/usb-gadget-network/remove-usbgadget-network.sh $destination/usr/local/bin/ ||
		exit_with_error "Failed to install USB gadget remove script"
	install -Dm744 $SRC/packages/bsp/usb-gadget-network/usbgadget-rndis.service $destination/usr/lib/systemd/system/ ||
		exit_with_error "Failed to install USB gadget service"
	install -Dm755 $SRC/packages/bsp/usb-gadget-network/usb-gadget-initramfs-hook $destination/etc/initramfs-tools/hooks/usb-gadget ||
		exit_with_error "Failed to install USB gadget initramfs hook"
	install -Dm755 $SRC/packages/bsp/usb-gadget-network/usb-gadget-initramfs-premount $destination/etc/initramfs-tools/scripts/init-premount/usb-gadget ||
		exit_with_error "Failed to install USB gadget initramfs premount script"
	install -Dm755 $SRC/packages/bsp/usb-gadget-network/dropbear $destination/etc/initramfs-tools/scripts/init-premount/ ||
		exit_with_error "Failed to install USB gadget initramfs premount dropbear"
	install -Dm755 $SRC/packages/bsp/usb-gadget-network/kill-dropbear $destination/etc/initramfs-tools/scripts/init-bottom/ ||
		exit_with_error "Failed to install USB gadget initramfs premount kill dropbear"
}

function post_family_tweaks__pocketbeagle2_enable_services() {
	display_alert "Enable Services for ${BOARD}" "${RELEASE}" "warn"

	# We need unudhcpd from armbian repo, so enable it
	mv "${SDCARD}"/etc/apt/sources.list.d/armbian.sources.disabled "${SDCARD}"/etc/apt/sources.list.d/armbian.sources
	do_with_retries 3 chroot_sdcard_apt_get_install unudhcpd
	# disable armbian repo back
	mv "${SDCARD}"/etc/apt/sources.list.d/armbian.sources "${SDCARD}"/etc/apt/sources.list.d/armbian.sources.disabled

	chroot_sdcard systemctl enable usbgadget-rndis.service
	# We want custom IPs. systemctl edit does not seem to work in chroot.
	mkdir -p "${SDCARD}"/etc/systemd/system/usbgadget-rndis.service.d
	echo -e "[Service]\nEnvironment=\"unudhcpd_host_ip=192.168.7.2\"\nEnvironment=\"unudhcpd_client_ip=192.168.7.3\"" > "${SDCARD}"/etc/systemd/system/usbgadget-rndis.service.d/override.conf
}

function current_beagle_kernel_uboot() {
	declare -g KERNELSOURCE="https://github.com/beagleboard/linux" # BeagleBoard kernel
	declare -g KERNEL_MAJOR_MINOR="6.12"
	declare -g KERNELBRANCH="branch:v6.12.24-ti-arm64-r43"
	declare -g LINUXFAMILY="k3-beagle" # Separate kernel package from the regular `k3` family

	declare -g BOOTSOURCE="https://github.com/beagleboard/u-boot" # BeagleBoard u-boot
	declare -g BOOTBRANCH="branch:v2025.07-am6232-pocketbeagle2"
}

#Until PB2 goes upstream, use this branch
function post_family_config_branch_current__pocketbeagle2_use_beagle_kernel_uboot() {
	display_alert "$BOARD" " beagleboard (current branch) u-boot and kernel overrides for $BOARD / $BRANCH" "info"
	current_beagle_kernel_uboot
}

function post_family_config_branch_current-rt__pocketbeagle2_use_beagle_kernel_uboot() {
	display_alert "$BOARD" " beagleboard (current-rt branch) u-boot and kernel overrides for $BOARD / $BRANCH" "info"
	current_beagle_kernel_uboot
}

#Until PB2 goes upstream, use this branch
function post_family_config_branch_edge__pocketbeagle2_use_beagle_kernel_uboot() {
	display_alert "$BOARD" " beagleboard (next branch) u-boot and kernel overrides for $BOARD / $BRANCH" "info"

	declare -g KERNELSOURCE="https://github.com/beagleboard/linux" # BeagleBoard kernel
	declare -g KERNEL_MAJOR_MINOR="6.12"
	declare -g KERNELBRANCH="branch:v6.12.24-ti-arm64-r43"
	declare -g LINUXFAMILY="k3-beagle" # Separate kernel package from the regular `k3` family

	declare -g BOOTSOURCE="https://github.com/beagleboard/u-boot" # BeagleBoard u-boot
	declare -g BOOTBRANCH="branch:v2025.07-am6232-pocketbeagle2"
}
