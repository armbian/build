# Rockchip RK3308 quad core 256-512MB SoC WiFi
# https://radxa.com/products/rockpi/pis

BOARD_NAME="Rockpi S"
BOARDFAMILY="rockchip64"
BOARD_MAINTAINER="brentr"

BOOTCONFIG="rock-pi-s-rk3308_defconfig"
BOOT_FDT_FILE="rockchip/rk3308-rock-pi-s.dtb"

KERNEL_TARGET="current,edge"
KERNEL_TEST_TARGET="current"

DEFAULT_CONSOLE="serial"
SERIALCON="ttyS0"
MODULES_BLACKLIST="rockchipdrm analogix_dp dw_mipi_dsi dw_hdmi gpu_sched lima hantro_vpu panfrost"
HAS_VIDEO_OUTPUT="no"
BOOTBRANCH_BOARD="tag:v2024.07"
BOOTPATCHDIR="v2024.07"

OVERLAY_PREFIX='rk3308'

#comment out line below for an image that will NOT boot from the built-in SDNAND
#u-boot version >= v2024 will not boot at all if this is commented out
IDBLOADER_BLOB=$SRC/packages/blobs/rockchip/rk3308_idbloader_ddr589MHz_uart0_m0_v2.06.136sd.bin

#The above IDBLOADER_BLOB requires the U-Boot and Linux serial console on UART0
#Linux will hang on reboot if the console remains on UART2

#Note:  IDBLOADER_BLOB is derived from
#  https://dl.radxa.com/rockpis/images/loader/rk3308_loader_ddr589MHz_uart0_m0_v2.06.136sd.bin
#by using the rkdeveloptool to "upgrade" the previous DDR_BLOB loader on the SDNAND
#To recreate it, build the image with IDBLOADER_BLOB unset and boot Rock PI-S in MASKROM mode
#On your host (connected to the RockPi-S's USB-C port):
#  rdeveloptool db rk3308_loader_ddr589MHz_uart0_m0_v2.06.136sd.bin
#  rdeveloptool wl 0 newly_built_image.img
#  rdeveloptool ul rk3308_loader_ddr589MHz_uart0_m0_v2.06.136sd.bin  #this writes 280 sectors

#Then, reset the RockPi-S to boot from SDNAND.  Using that running image:
#  dd if=/dev/mmcblk0 of=rk3308_idbloader_ddr589MHz_uart0_m0_v2.06.136sd.bin skip=64 count=280

function post_family_config__uboot_config() {
	display_alert "$BOARD" "custom prep for u-boot ${BOOTBRANCH_BOARD}" "info"

	BOOTSCRIPT=boot-rockchip64-ttyS0.cmd:boot.cmd
        DDR_BLOB=rk33/rk3308_ddr_589MHz_uart0_m0_v1.26.bin

	uboot_custom_postprocess() {  #overrides rockchip64_common.inc
		# TODO: remove this diversion from common caused by different loaderimage params
		run_host_x86_binary_logged $RKBIN_DIR/tools/loaderimage --pack --uboot ./u-boot-dtb.bin uboot.img 0x600000 --size 1024 1 &&
		if [ -r "$IDBLOADER_BLOB" ]; then
			display_alert "$BOARD" "Installing SDNAND boot capable $IDBLOADER_BLOB" "info"
			cp $IDBLOADER_BLOB idbloader.bin
		else
			[ "$IDBLOADER_BLOB" ] && display_alert "$BOARD" "Missing $IDBLOADER_BLOB" "info"
			display_alert "$BOARD" "This image may not boot from integrated SDNAND" "warning"
			tools/mkimage -n rk3308 -T rksd -d $RKBIN_DIR/$DDR_BLOB idbloader.bin &&
			cat $RKBIN_DIR/$MINILOADER_BLOB >> idbloader.bin
		fi &&
		run_host_x86_binary_logged $RKBIN_DIR/tools/trust_merger --replace bl31.elf $RKBIN_DIR/$BL31_BLOB trust.ini
	}

	family_tweaks_bsp() { #overrides rockchip64_common.inc
                #Install udev script that derives fixed, unique MAC addresses for net interfaces
		#that are assigned random ones -- like RockPI-S's WiFi network interfaces
		bsp=$SRC/packages/bsp/rockpis
		rules=etc/udev/rules.d

		install -m 755 $bsp/lib/udev/fixEtherAddr $destination/lib/udev &&
		install -m 644 $bsp/$rules/05-fixMACaddress.rules $destination/$rules
	}

}
