# Qualcomm Dragonwing QCS6490
declare -g BOARD_NAME="Radxa Dragon Q6A"
declare -g BOARD_VENDOR="radxa"
declare -g BOARD_MAINTAINER="HeyMeco"
declare -g BOARDFAMILY="qcs6490"
declare -g KERNEL_TARGET="current"
declare -g BOOTCONFIG="none"
declare -g IMAGE_PARTITION_TABLE="gpt"
enable_extension "radxa-aic8800"
AIC8800_TYPE="usb"

# Use the full firmware, complete linux-firmware plus Armbian's (for qcom/qcs6490/a660_zap.mbn)
declare -g BOARD_FIRMWARE_INSTALL="-full"

declare -g BOOT_FDT_FILE="qcom/qcs6490-radxa-dragon-q6a.dtb"

function post_family_tweaks_bsp__radxa-dragon-q6a_bsp_firmware_in_initrd() {
	display_alert "Adding to bsp-cli" "${BOARD}: firmware in initrd" "info"
	declare file_added_to_bsp_destination # will be filled in by add_file_from_stdin_to_bsp_destination
	add_file_from_stdin_to_bsp_destination "/etc/initramfs-tools/hooks/initramfs-hook-qcs6490-fw" <<- 'FIRMWARE_HOOK'
		#!/bin/bash
		[[ "$1" == "prereqs" ]] && exit 0
		. /usr/share/initramfs-tools/hook-functions
		add_firmware "qcom/qcs6490/a660_zap.mbn" # extra one for gpu
		add_firmware "qcom/a660_sqe.fw" # extra one for dpu
		add_firmware "qcom/qcs6490/radxa/dragon-q6a/adsp.mbn" # extra one for remoteproc0
		add_firmware "qcom/qcs6490/radxa/dragon-q6a/cdsp.mbn" # extra one for remoteproc1
		add_firmware "qcom/qcs6490/QCS6490-Radxa-Dragon-Q6A-tplg.bin" # extra one for sound
	FIRMWARE_HOOK
	run_host_command_logged chmod -v +x "${file_added_to_bsp_destination}"
}

function post_family_tweaks__radxa-dragon-q6a_install_alsa_ucm_conf() {
	# Only install for kernel 6.18.x
	if [[ "${KERNEL_MAJOR_MINOR}" == "6.18" ]]; then
		display_alert "Installing alsa-ucm-conf" "${BOARD}: Radxa ALSA UCM configuration" "info"

		declare alsa_ucm_url="https://github.com/radxa-pkg/alsa-ucm-conf/releases/download/1.2.14-1radxa2/alsa-ucm-conf_1.2.14-1radxa2_all.deb"
		declare alsa_ucm_deb="/tmp/alsa-ucm-conf_1.2.14-1radxa2_all.deb"

		# Download the package
		run_host_command_logged wget -O "${SDCARD}${alsa_ucm_deb}" "${alsa_ucm_url}"

		# Install in chroot
		chroot_sdcard dpkg -i "${alsa_ucm_deb}"

		# Clean up
		run_host_command_logged rm -f "${SDCARD}${alsa_ucm_deb}"
	else
		display_alert "Skipping alsa-ucm-conf installation" "Kernel version ${KERNEL_MAJOR_MINOR} != 6.18" "info"
	fi
}
