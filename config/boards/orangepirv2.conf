# OrangePi RV2 - RISC-V SoC with SPI flash boot
BOARD_NAME="Orange Pi RV2"
BOARDFAMILY="ky"
BOARD_MAINTAINER="tmshlvck"
KERNEL_TARGET="current,edge"
BOOT_FDT_FILE="ky/x1_orangepi-rv2.dtb"
BOOTDELAY=1
SRC_EXTLINUX="yes"
SRC_CMDLINE="console=ttyS0,115200 earlycon=sbi clk_ignore_unused swiotlb=65536"
PACKAGE_LIST_BOARD="rfkill bluetooth bluez bluez-tools can-utils v4l-utils"
#SKIP_BOOTSPLASH="yes" # Skip boot splash patch, conflicts with CONFIG_VT=yes

function post_config_uboot_target__extra_configs_for_orangepi_rv2() {
	display_alert "u-boot for ${BOARD}" "u-boot: enabling extra configs for SPI flash boot" "info"
	run_host_command_logged scripts/config --enable CONFIG_SD_BOOT
	run_host_command_logged scripts/config --enable CONFIG_EXT4_WRITE
	run_host_command_logged scripts/config --enable CONFIG_FS_BTRFS
	run_host_command_logged scripts/config --enable CONFIG_CMD_BTRFS
	run_host_command_logged scripts/config --enable CONFIG_CMD_SF
	run_host_command_logged scripts/config --enable CONFIG_SPI_FLASH
	run_host_command_logged scripts/config --enable CONFIG_SPI_FLASH_MTD
	run_host_command_logged scripts/config --enable CONFIG_CMD_MTD
}

function post_family_tweaks_bsp__orangepi_rv2_extras() {
	display_alert "$BOARD" "Installing OrangePi RV2 specific configuration" "info"

	if [[ -d "$SRC/packages/blobs/riscv64/ky" ]]; then
		run_host_command_logged mkdir -pv "${destination}"/lib/firmware
		display_alert "$BOARD" "Installing boot firmware" "info"
		run_host_command_logged cp -fv $SRC/packages/blobs/riscv64/ky/esos.elf "${destination}"/lib/firmware
	fi

	# Force load wireless module if available
	if [[ -f "${destination}"/etc/modules-load.d/${BOARD}.conf ]]; then
		run_host_command_logged rm -f "${destination}"/etc/modules-load.d/${BOARD}.conf
	fi
	run_host_command_logged mkdir -pv "${destination}"/etc/modules-load.d

	# Add wireless module for AP6256 if present
	if [[ "${BOARD}x" == "orangepirv2x" ]]; then
		echo "bcmdhd" > "${destination}"/etc/modules-load.d/${BOARD}.conf

		# Copy WiFi firmware if available
		if [[ -f "${SRC}/packages/blobs/ky/nvram_ap6256.txt" ]]; then
			run_host_command_logged mkdir -pv "${destination}"/lib/firmware
			run_host_command_logged cp -v "${SRC}/packages/blobs/ky/nvram_ap6256.txt" "${destination}"/lib/firmware/
		fi
	fi
}
