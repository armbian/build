# Allwinner H618 quad core 1/2/4GB RAM SoC WiFi SPI USB-C
BOARD_NAME="KickPi K2B"
BOARDFAMILY="sun50iw9-bpi"
BOARD_MAINTAINER="pyavitz"
BOOTCONFIG="kickpi_k2b_defconfig"
OVERLAY_PREFIX="sun50i-h616"
BOOT_FDT_FILE="sun50i-h618-kickpi-k2b.dtb"
BOOT_LOGO="desktop"
KERNEL_TARGET="current,edge"
KERNEL_TEST_TARGET="current"
FORCE_BOOTSCRIPT_UPDATE="yes"
BOOTBRANCH_BOARD="tag:v2025.01"
BOOTPATCHDIR="v2025.01"
PACKAGE_LIST_BOARD="rfkill bluetooth bluez bluez-tools"

function post_family_tweaks_bsp__kickpi_k2b_aic8800() {
	display_alert "$BOARD" "Installing AIC8800 Support" "info"
	mkdir -p "${destination}"/etc/modprobe.d
	mkdir -p "${destination}"/etc/modules-load.d
	mkdir -p "${destination}"/etc/systemd/system
	mkdir -p "${destination}"/lib/firmware/updates
	mkdir -p "${destination}"/usr/bin
	# Install firmware
	git clone --depth=1 -q -b aic8800_sdio https://github.com/pyavitz/firmware.git "${destination}"/lib/firmware/updates/aic8800
	rm -fdr "${destination}"/lib/firmware/updates/aic8800/.git
	# Add udev rule
	cat <<EOF > "${destination}"/etc/modprobe.d/aic8800-wireless.conf
options aic8800_fdrv aicwf_dbg_level=0 custregd=0 ps_on=0
EOF
	# Add needed bluetooth modules
	cat <<EOF > "${destination}"/etc/modules-load.d/aic8800-btlpm.conf
hidp
rfcomm
bnep
aic8800_btlpm
EOF
	# Install Bluetooth helper script and service
	cat <<EOF > "${destination}"/usr/bin/aic-bthelper
#!/bin/bash

# HW Reset
hciattach -r -s 1500000 /dev/ttyS1 any 1500000 flow nosleep > /dev/null 2>&1

# Kill hciattach
sleep .50
killall hciattach

# Attach Bluetooth HCI UART
sleep .50
hciattach -s 1500000 /dev/ttyS1 any 1500000 flow nosleep > /dev/null 2>&1
rfkill unblock all

exit 0
EOF
	chmod +x "${destination}"/usr/bin/aic-bthelper
	cat <<EOF > "${destination}"/etc/systemd/system/bthelper.service
[Unit]
Description=Bluetooth Helper
After=bluetooth.service bluetooth.target getty.target
Requires=bluetooth.service bluetooth.target getty.target

[Service]
Type=idle
ExecStartPre=/usr/sbin/rfkill unblock all
ExecStart=/usr/bin/aic-bthelper
TimeoutStartSec=0
RemainAfterExit=yes
SysVStartPriority=99

[Install]
WantedBy=multi-user.target
EOF
}

function post_family_tweaks__enable_aic8800_bthelper() {
	display_alert "$BOARD" "Enabling AIC8800 Bluetooth Helper" "info"
	chroot_sdcard systemctl --no-reload enable bthelper.service
}
