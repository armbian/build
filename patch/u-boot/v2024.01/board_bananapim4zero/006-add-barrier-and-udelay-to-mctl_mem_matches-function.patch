From f3f90bf6a9853596eed287f2860f0b91f534fcd0 Mon Sep 17 00:00:00 2001
From: Patrick Yavitz <pyavitz@xxxxx.com>
Date: Thu, 29 Feb 2024 21:16:59 -0500
Subject: [PATCH] add barrier and udelay to mctl_mem_matches function

https://lore.kernel.org/all/ZWMv816r8YxPwsJO@BOB1/T/#mec26415158efa10e6f78c5c1a651bb834f8599c4

Signed-off-by: Patrick Yavitz <pyavitz@xxxxx.com>
---
 arch/arm/mach-sunxi/dram_helpers.c | 4 ++++
 1 file changed, 4 insertions(+)

diff --git a/arch/arm/mach-sunxi/dram_helpers.c b/arch/arm/mach-sunxi/dram_helpers.c
index cdf2750f1c..03caaad28a 100644
--- a/arch/arm/mach-sunxi/dram_helpers.c
+++ b/arch/arm/mach-sunxi/dram_helpers.c
@@ -10,6 +10,7 @@
 #include <asm/barriers.h>
 #include <asm/io.h>
 #include <asm/arch/dram.h>
+#include <linux/delay.h>
 
 /*
  * Wait up to 1s for value to be set in given part of reg.
@@ -34,8 +35,11 @@ bool mctl_mem_matches(u32 offset)
 {
 	/* Try to write different values to RAM at two addresses */
 	writel(0, CFG_SYS_SDRAM_BASE);
+	dsb();
+	udelay(1000);
 	writel(0xaa55aa55, (ulong)CFG_SYS_SDRAM_BASE + offset);
 	dsb();
+	udelay(1000);
 	/* Check if the same value is actually observed when reading back */
 	return readl(CFG_SYS_SDRAM_BASE) ==
 	       readl((ulong)CFG_SYS_SDRAM_BASE + offset);
-- 
2.39.2

