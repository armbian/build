From 2a58f8a9e8138c7918ffcb68d147ed2c3eea5985 Mon Sep 17 00:00:00 2001
From: hongruichen <chraac@gmail.com>
Date: Thu, 23 May 2024 22:35:08 +0800
Subject: [PATCH] dts:  orangepi zero2w fix emac

This reverts commit 50c47db7dc1adfde1ce9b84020b0f8391de3563a.
---
 .../arm64/boot/dts/allwinner/sun50i-h616.dtsi | 25 +++++++----
 .../allwinner/sun50i-h618-orangepi-zero2w.dts | 41 ++++++++-----------
 2 files changed, 35 insertions(+), 31 deletions(-)

diff --git a/arch/arm64/boot/dts/allwinner/sun50i-h616.dtsi b/arch/arm64/boot/dts/allwinner/sun50i-h616.dtsi
index 3a2a1c4f327a..90e55a6aef1d 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-h616.dtsi
+++ b/arch/arm64/boot/dts/allwinner/sun50i-h616.dtsi
@@ -209,7 +209,7 @@ video-codec@1c0e000 {
 
 		syscon: syscon@3000000 {
 			compatible = "allwinner,sun50i-h616-system-control";
-			reg = <0x03000000 0x1000>;
+			reg = <0x03000000 0x30>,<0x03000038 0x0fc8>;
 			#address-cells = <1>;
 			#size-cells = <1>;
 			ranges;
@@ -708,19 +708,28 @@ mdio0: mdio {
 		};
 
 		emac1: ethernet@5030000 {
-			compatible = "allwinner,sun50i-h616-emac";
-			syscon = <&syscon 1>;
-			reg = <0x05030000 0x10000>;
+			compatible = "allwinner,sunxi-gmac";
+			reg = <0x05030000 0x10000>,
+			      <0x03000034 0x4>;
+			reg-names = "gmac1_reg","ephy_reg";
 			interrupts = <GIC_SPI 15 IRQ_TYPE_LEVEL_HIGH>;
-			interrupt-names = "macirq";
+			interrupt-names = "gmacirq";
 			resets = <&ccu RST_BUS_EMAC1>;
 			reset-names = "stmmaceth";
-			clocks = <&ccu CLK_BUS_EMAC1>;
-			clock-names = "stmmaceth";
+			clocks = <&ccu CLK_BUS_EMAC1>,<&ccu CLK_EMAC_25M>;
+			clock-names = "bus-emac1","emac-25m";
+			pinctrl-0 = <&rmii_pins>;
+			pinctrl-names = "default";
+			tx-delay = <7>;
+			rx-delay = <31>;
+			phy-rst;
+			gmac-power0;
+			gmac-power1;
+			gmac-power2;
 			status = "disabled";
 
 			mdio1: mdio {
-				compatible = "snps,dwmac-mdio";
+				compatible = "ethernet-phy-ieee802.3-c22";
 				#address-cells = <1>;
 				#size-cells = <0>;
 			};
diff --git a/arch/arm64/boot/dts/allwinner/sun50i-h618-orangepi-zero2w.dts b/arch/arm64/boot/dts/allwinner/sun50i-h618-orangepi-zero2w.dts
index 7eafe5208760..2a4c152b9294 100644
--- a/arch/arm64/boot/dts/allwinner/sun50i-h618-orangepi-zero2w.dts
+++ b/arch/arm64/boot/dts/allwinner/sun50i-h618-orangepi-zero2w.dts
@@ -200,19 +200,23 @@ &mmc1 {
 };
 
 &emac0 {
+	status = "disabled";
+};
+
+&emac1 {
 	pinctrl-names = "default";
-	pinctrl-0 = <&ext_rgmii_pins>;
-	phy-handle = <&ext_rgmii_phy>;
-	allwinner,tx-delay-ps = <700>;
-	phy-mode = "rgmii-rxid";
+	pinctrl-0 = <&rmii_pins>;
+	phy-mode = "rmii";
+	phy-handle = <&rmii_phy>;
 	phy-supply = <&reg_dldo1>;
+	allwinner,rx-delay-ps = <3100>;
+	allwinner,tx-delay-ps = <700>;
 	status = "okay";
 };
 
-&mdio0 {
-	ext_rgmii_phy: ethernet-phy@1 {
+&mdio1 {
+	rmii_phy: ethernet-phy@1 {
 		compatible = "ethernet-phy-ieee802.3-c22";
-		motorcomm,clk-out-frequency-hz = <125000000>;
 		reg = <1>;
 	};
 };
@@ -313,25 +317,16 @@ &i2c3 {
 	pinctrl-names = "default";
 	pinctrl-0 = <&i2c3_pa_pins>;
 
-	ac200: mfd@10 {
-		compatible = "x-powers,ac200";
+	ac200_x: mfd@10 {
+		compatible = "x-powers,ac200-sunxi";
 		reg = <0x10>;
 		clocks = <&ac200_pwm_clk>;
 		// ephy id
-		interrupt-parent = <&pio>;
-		interrupts = <1 20 IRQ_TYPE_LEVEL_LOW>;
-		interrupt-controller;
-		#interrupt-cells = <1>;
-		nvmem-cells = <&ac200_bg>;
-		nvmem-cell-names = "bandgap";
-
-		ac200_ephy_ctl: syscon {
-			compatible = "x-powers,ac200-ephy-ctl";
-			#clock-cells = <0>;
-			#reset-cells = <0>;
-			phy-mode = "rmii";
-			nvmem-cells = <&ephy_calibration>;
-			nvmem-cell-names = "calibration";
+		nvmem-cells = <&ephy_calibration>;
+		nvmem-cell-names = "calibration";
+
+		ac200_ephy: phy {
+			compatible = "x-powers,ac200-ephy-sunxi";
 			status = "okay";
 		};
 	};
-- 
GitLab
