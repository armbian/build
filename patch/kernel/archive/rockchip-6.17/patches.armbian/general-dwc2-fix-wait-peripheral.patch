From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Paolo Sabatino <paolo.sabatino@gmail.com>
Date: Sat, 2 Mar 2024 21:56:44 +0100
Subject: dwc2: add fixes for rk322x peripheral mode

---
 drivers/usb/dwc2/core.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/usb/dwc2/core.c b/drivers/usb/dwc2/core.c
index 111111111111..222222222222 100644
--- a/drivers/usb/dwc2/core.c
+++ b/drivers/usb/dwc2/core.c
@@ -538,6 +538,9 @@ void dwc2_force_mode(struct dwc2_hsotg *hsotg, bool host)
 	gusbcfg |= set;
 	dwc2_writel(hsotg, gusbcfg, GUSBCFG);
 
+	/* On some rockchip platforms, this fixes hang on reset in peripheral mode */
+	msleep(10);
+
 	dwc2_wait_for_mode(hsotg, host);
 	return;
 }
-- 
Armbian

