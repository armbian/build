From bfe1ecf46ad4f125703d01d23b292b80dfb22365 Mon Sep 17 00:00:00 2001
From: Patrick Yavitz <pyavitz@gmail.com>
Date: Wed, 4 Feb 2026 07:41:54 -0500
Subject: [PATCH] Add a wait_for_completion_idle_timeout to normalize load avg

Source: https://strl.cat/posts/2025/08/2025-08-07-qzowm

Signed-off-by: Patrick Yavitz <pyavitz@gmail.com>
---
 include/linux/completion.h | 2 ++
 kernel/sched/completion.c  | 7 +++++++
 2 files changed, 9 insertions(+)

diff --git a/include/linux/completion.h b/include/linux/completion.h
index fb2915676..c62abe10c 100644
--- a/include/linux/completion.h
+++ b/include/linux/completion.h
@@ -106,6 +106,8 @@ extern int wait_for_completion_killable(struct completion *x);
 extern int wait_for_completion_state(struct completion *x, unsigned int state);
 extern unsigned long wait_for_completion_timeout(struct completion *x,
 						   unsigned long timeout);
+extern unsigned long wait_for_completion_idle_timeout(struct completion *x,
+                                                  unsigned long timeout);
 extern unsigned long wait_for_completion_io_timeout(struct completion *x,
 						    unsigned long timeout);
 extern long wait_for_completion_interruptible_timeout(
diff --git a/kernel/sched/completion.c b/kernel/sched/completion.c
index 19ee70227..74e5dc660 100644
--- a/kernel/sched/completion.c
+++ b/kernel/sched/completion.c
@@ -173,6 +173,13 @@ wait_for_completion_timeout(struct completion *x, unsigned long timeout)
 }
 EXPORT_SYMBOL(wait_for_completion_timeout);
 
+unsigned long __sched
+wait_for_completion_idle_timeout(struct completion *x, unsigned long timeout)
+{
+       return wait_for_common(x, timeout, TASK_IDLE);
+}
+EXPORT_SYMBOL(wait_for_completion_idle_timeout);
+
 /**
  * wait_for_completion_io: - waits for completion of a task
  * @x:  holds the state of this particular completion
-- 
2.51.0

