From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: HackingGate <i@hackinggate.com>
Date: Sun, 26 Oct 2025 17:48:01 +0900
Subject: [PATCH] PCI: rockchip: enable bus mastering on endpoints

Rockchip DesignWare PCIe hosts ship with bus mastering disabled on both
root ports and downstream devices. DMA-capable endpoints such as ath11k
cannot load their firmware via MHI and fail with -110 timeouts unless the
Bus Master Enable bit is asserted.

Add a PCI quirk that enables bus mastering for Rockchip root ports and
for endpoints attached behind them so that DMA can proceed normally.

Fixes: wcn6855 hw2.0 "failed to power up mhi: -110"

Signed-off-by: HackingGate <i@hackinggate.com>
---
 drivers/pci/quirks.c | 30 ++++++++++++++++++++++++++++++
 1 file changed, 30 insertions(+)

diff --git a/drivers/pci/quirks.c b/drivers/pci/quirks.c
index 214ed060ca1b..89aa6ee8d029 100644
--- a/drivers/pci/quirks.c
+++ b/drivers/pci/quirks.c
@@ -5654,6 +5654,36 @@ DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_INTEL, 0x145a, quirk_intel_e2000_no_ats);
 DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_INTEL, 0x145c, quirk_intel_e2000_no_ats);
 #endif /* CONFIG_PCI_ATS */
 
+/*
+ * Rockchip DesignWare PCIe controller doesn't enable bus master for endpoints.
+ * Ensure bus mastering is enabled for root ports and attached endpoints.
+ */
+static void quirk_rockchip_pcie_enable_bus_master(struct pci_dev *dev)
+{
+	struct pci_dev *bridge;
+	u16 vendor;
+
+	/* Rockchip root ports also need BME asserted to forward DMA */
+	if (dev->vendor == PCI_VENDOR_ID_ROCKCHIP) {
+		if (pci_is_bridge(dev))
+			pci_set_master(dev);
+		return;
+	}
+
+	if (pci_is_bridge(dev))
+		return;
+
+	bridge = pci_upstream_bridge(dev);
+	if (!bridge)
+		return;
+
+	/* Check if attached to Rockchip PCIe controller */
+	pci_read_config_word(bridge, PCI_VENDOR_ID, &vendor);
+	if (vendor == PCI_VENDOR_ID_ROCKCHIP)
+		pci_set_master(dev);
+}
+DECLARE_PCI_FIXUP_FINAL(PCI_ANY_ID, PCI_ANY_ID, quirk_rockchip_pcie_enable_bus_master);
+
 /* Freescale PCIe doesn't support MSI in RC mode */
 static void quirk_fsl_no_msi(struct pci_dev *pdev)
 {
-- 
2.47.3

