From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: HackingGate <i@hackinggate.com>
Date: Sat, 11 Oct 2025 00:02:00 +0900
Subject: [PATCH] pwm: rockchip-v4: Set DT node for OF xlate support

The MFPWM driver creates child platform devices without device tree nodes.
The PWM v4 driver needs to:
1. Set the PWM chip's of_node to the parent MFPWM device's DT node
2. Configure the OF xlate callback to parse 3-cell DT bindings

The RK3576 PWM binding uses 3 cells (channel, period, flags) as defined by
#pwm-cells = <3> in the device tree. Without proper of_xlate configuration,
PWM consumers fail with "Failed to request PWM device" because the PWM core
can't parse the phandle arguments correctly.

Signed-off-by: HackingGate <i@hackinggate.com>
---
 drivers/pwm/pwm-rockchip-v4.c | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/drivers/pwm/pwm-rockchip-v4.c b/drivers/pwm/pwm-rockchip-v4.c
index 111111111111..222222222222 100644
--- a/drivers/pwm/pwm-rockchip-v4.c
+++ b/drivers/pwm/pwm-rockchip-v4.c
@@ -305,7 +305,8 @@ static int rockchip_pwm_v4_probe(struct platform_device *pdev)
 	struct device *dev = &pdev->dev;
 	int ret;
 
-	chip = devm_pwmchip_alloc(dev, 1, sizeof(*pc));
+	/* Allocate chip with parent MFPWM device for proper device links */
+	chip = devm_pwmchip_alloc(dev->parent, 1, sizeof(*pc));
 	if (IS_ERR(chip))
 		return PTR_ERR(chip);
 
@@ -332,6 +333,10 @@ static int rockchip_pwm_v4_probe(struct platform_device *pdev)
 	platform_set_drvdata(pdev, chip);
 
 	chip->ops = &rockchip_pwm_v4_ops;
+	/* Link PWM chip to parent MFPWM device's DT node for OF xlate */
+	chip->dev.of_node = dev->parent->of_node;
+	/* Configure OF xlate for 3-cell DT bindings (channel, period, flags) */
+	chip->of_xlate = of_pwm_xlate_with_flags;
 
 	ret = pwmchip_add(chip);
 	if (ret)
-- 
2.39.2
