From b159c55f7d9f81f3c7aa5ae041c1d0ec61281af4 Mon Sep 17 00:00:00 2001
From: Paolo Sabatino <paolo.sabatino@gmail.com>
Date: Mon, 25 Nov 2024 17:02:05 +0100
Subject: [PATCH] rk3308: various fixes and enhancements for rockpi-s

---
 .../boot/dts/rockchip/rk3308-rock-pi-s.dts    | 51 +++++++++++++++++++
 1 file changed, 51 insertions(+)

diff --git a/arch/arm64/boot/dts/rockchip/rk3308-rock-pi-s.dts b/arch/arm64/boot/dts/rockchip/rk3308-rock-pi-s.dts
index 5ca0cc19f92c..817684e54617 100644
--- a/arch/arm64/boot/dts/rockchip/rk3308-rock-pi-s.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3308-rock-pi-s.dts
@@ -48,6 +48,30 @@ blue-led {
 		};
 	};
 
+	pcm5102_sound: pcm5102-sound {
+		compatible = "simple-audio-card";
+		simple-audio-card,format = "i2s";
+		simple-audio-card,mclk-fs = <256>;
+		simple-audio-card,name = "lineout";
+
+		simple-audio-card,dai-link@1 {
+			format = "i2s";
+			cpu {
+				sound-dai = <&i2s_8ch_0>;
+			};
+
+			codec {
+				sound-dai = <&pcm5102a>;
+			};
+		};
+	};
+
+	pcm5102a: pcm5102a {
+			#sound-dai-cells = <0>;
+			compatible = "ti,pcm5102a";
+			pcm510x,format = "i2s";
+	};
+
 	sdio_pwrseq: sdio-pwrseq {
 		compatible = "mmc-pwrseq-simple";
 		pinctrl-0 = <&wifi_enable_h>;
@@ -128,6 +152,11 @@ vdd_log: vdd-log {
 	};
 };
 
+&acodec {
+	status = "okay";
+	#sound-dai-cells = <0>;
+};
+
 &cpu0 {
 	cpu-supply = <&vdd_core>;
 };
@@ -139,6 +168,7 @@ &emmc {
 	non-removable;
 	pinctrl-names = "default";
 	pinctrl-0 = <&emmc_bus8 &emmc_clk &emmc_cmd>;
+	mmc-hs200-1_8v;
 	vmmc-supply = <&vcc_io>;
 	status = "okay";
 };
@@ -170,6 +200,19 @@ &i2c1 {
 	status = "okay";
 };
 
+&i2s_8ch_0 {
+	#sound-dai-cells = <0>;
+	assigned-clocks = <&cru SCLK_I2S0_8CH_RX>;
+	assigned-clock-parents = <&cru SCLK_I2S0_8CH_TX_MUX>;
+	rockchip,clk-trcm = <1>;
+	status = "okay";
+};
+
+&i2s_8ch_2 {
+	#sound-dai-cells = <0>;
+	status = "disabled";
+};
+
 &pinctrl {
 	pinctrl-names = "default";
 	pinctrl-0 = <&rtc_32k>;
@@ -261,10 +304,18 @@ &sdmmc {
 	cap-mmc-highspeed;
 	cap-sd-highspeed;
 	disable-wp;
+	pinctrl-0 = <&sdmmc_clk &sdmmc_cmd &sdmmc_det &sdmmc_bus4>;
+	card-detect-delay = <800>;
 	vmmc-supply = <&vcc_io>;
 	status = "okay";
 };
 
+&tsadc {
+	rockchip,hw-tshut-mode = <0>;		/* 0:CRU */
+	rockchip,hw-tshut-polarity = <1>;	/* 1:HIGH */
+	status = "okay";
+};
+
 &u2phy {
 	status = "okay";
 
-- 
2.43.0

