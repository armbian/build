From b8a589bd3322f55d7642e2c32f5aceb33c792e6e Mon Sep 17 00:00:00 2001
From: Frank Wunderlich <frank-w@public-files.de>
Date: Sun, 14 Jan 2024 14:47:21 +0100
Subject: [PATCH 68/84] kdeb: try to add kernels for bpi-boards to deb-packages

---
 scripts/package/builddeb | 41 ++++++++++++++++++++++++++++++++++++++--
 1 file changed, 39 insertions(+), 2 deletions(-)

diff --git a/scripts/package/builddeb b/scripts/package/builddeb
index 3627ca227e5a..4c2142959768 100755
--- a/scripts/package/builddeb
+++ b/scripts/package/builddeb
@@ -61,9 +61,46 @@ install_linux_image () {
 	parisc|mips|powerpc)
 		installed_image_path="boot/vmlinux-${KERNELRELEASE}";;
 	*)
-		installed_image_path="boot/vmlinuz-${KERNELRELEASE}";;
+		source_image_path="./$board.itb"
+		installed_image_path=boot/$board-${KERNELRELEASE}.itb
+		case $board in
+		bpi-r2)
+			mkdir -p "${pdir}/boot/bananapi/$board/linux/dtb"
+			DTBFILE=arch/arm/boot/dts/mediatek/mt7623n-bananapi-bpi-r2.dtb
+			cp ${srctree}/uImage_nodt "${pdir}/boot/bananapi/$board/linux/uImage-${KERNELRELEASE}_nodt"
+			source_image_path="${srctree}/uImage"
+			installed_image_path="boot/bananapi/$board/linux/uImage-${KERNELRELEASE}"
+			;;
+		bpi-r64)
+			mkdir -p "${pdir}/boot/bananapi/$board/linux/dtb"
+			DTBFILE=arch/arm64/boot/dts/mediatek/mt7622-bananapi-bpi-r64.dtb
+			cp ${srctree}/uImage_nodt "${pdir}/boot/bananapi/$board/linux/uImage-${KERNELRELEASE}_nodt"
+			;;
+		bpi-r2pro)
+			DTBFILE=arch/arm64/boot/dts/rockchip/rk3568-bpi-r2-pro.dtb
+			mkdir -p ${pdir}/boot/extlinux/
+			cp arch/arm64/boot/Image.gz "${pdir}/boot/extlinux/Image-${KERNELRELEASE}.gz"
+			;;
+		bpi-r3|bpi-r4)
+			#R3/R4 only use FIT and no standalone kernel/dtbs
+			;;
+		*)
+			installed_image_path="boot/vmlinuz-${KERNELRELEASE}"
+			source_image_path="$($MAKE -s -f ${srctree}/Makefile image_name)"
+			;;
+		esac
+		;;
 	esac
-	cp "$(${MAKE} -s -f ${srctree}/Makefile image_name)" "${pdir}/${installed_image_path}"
+
+	if [ -n "$DTBFILE" ];then
+		if [ $board != "bpi-r2pro" ];then
+			cp $DTBFILE "${pdir}/boot/bananapi/$board/linux/dtb/$board-${KERNELRELEASE}.dtb"
+		else
+			cp $DTBFILE "${pdir}/boot/extlinux/$board-${KERNELRELEASE}.dtb"
+		fi
+	fi
+
+	cp "${source_image_path}" "${pdir}/${installed_image_path}"
 
 	if [ "${ARCH}" != um ]; then
 		install_maint_scripts "${pdir}"
-- 
2.30.2

