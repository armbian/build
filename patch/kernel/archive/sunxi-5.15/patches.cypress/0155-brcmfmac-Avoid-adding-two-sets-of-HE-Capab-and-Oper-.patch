From 4bc730179a645079ab8726b8d7c635df507b48aa Mon Sep 17 00:00:00 2001
From: Carter Chen <carter.chen@infineon.com>
Date: Fri, 21 Oct 2022 00:28:37 -0500
Subject: [PATCH 155/179] brcmfmac: Avoid adding two sets of HE Capab and Oper
 IE to the outgoing mgmt frames

Fixes: SWWLAN-143520
Signed-off-by: Carter Chen <carter.chen@infineon.com>
---
 .../net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c  | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
index 76dc9de86f64..a082b994ce81 100644
--- a/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
+++ b/drivers/net/wireless/broadcom/brcm80211/brcmfmac/cfg80211.c
@@ -5215,6 +5215,15 @@ brcmf_parse_extension_ies(const u8 *extension_ie_buf, u32 extension_ie_len,
 			goto next;
 		}
 
+		/* skip parsing the HE capab & oper IE from upper layer
+		 * to avoid sending it to the FW, as these IEs will be
+		 * added by the FW based on the MAC & PHY capab if HE
+		 * is enabled.
+		 */
+		if (ext_ie->id == WLAN_EID_EXT_HE_CAPABILITY ||
+		    ext_ie->id == WLAN_EID_EXT_HE_OPERATION)
+			goto next;
+
 		parsed_info = &extension_ies->ie_info[extension_ies->count];
 
 		parsed_info->ie_ptr = (char *)ext_ie;
-- 
2.17.1

