From 30d41451716f2f47214c6d18633941a29f4d20b3 Mon Sep 17 00:00:00 2001
From: Carella Chen <carella.chen@infineon.com>
Date: Thu, 18 Nov 2021 03:28:47 -0600
Subject: [PATCH 107/179] nl80211: add roaming offload support

Add NL80211_EXT_FEATURE_ROAM_OFFLOAD for roaming offload support.

Signed-off-by: Carella Chen <carella.chen@infineon.com>

---
 include/uapi/linux/nl80211.h | 1 +
 net/wireless/nl80211.c       | 4 +++-
 2 files changed, 4 insertions(+), 1 deletion(-)

diff --git a/include/uapi/linux/nl80211.h b/include/uapi/linux/nl80211.h
index 560f54bb492c..ee80ae025b44 100644
--- a/include/uapi/linux/nl80211.h
+++ b/include/uapi/linux/nl80211.h
@@ -6063,6 +6063,7 @@ enum nl80211_ext_feature_index {
 	NL80211_EXT_FEATURE_SECURE_RTT,
 	NL80211_EXT_FEATURE_PROT_RANGE_NEGO_AND_MEASURE,
 	NL80211_EXT_FEATURE_BSS_COLOR,
+	NL80211_EXT_FEATURE_ROAM_OFFLOAD,
 
 	/* add new features before the definition below */
 	NUM_NL80211_EXT_FEATURES,
diff --git a/net/wireless/nl80211.c b/net/wireless/nl80211.c
index 4e200f640a3b..a753c96c3659 100644
--- a/net/wireless/nl80211.c
+++ b/net/wireless/nl80211.c
@@ -14369,7 +14369,9 @@ static int nl80211_set_pmk(struct sk_buff *skb, struct genl_info *info)
 		return -EOPNOTSUPP;
 
 	if (!wiphy_ext_feature_isset(&rdev->wiphy,
-				     NL80211_EXT_FEATURE_4WAY_HANDSHAKE_STA_1X))
+				     NL80211_EXT_FEATURE_4WAY_HANDSHAKE_STA_1X) &&
+	    !wiphy_ext_feature_isset(&rdev->wiphy,
+				     NL80211_EXT_FEATURE_ROAM_OFFLOAD))
 		return -EOPNOTSUPP;
 
 	if (!info->attrs[NL80211_ATTR_MAC] || !info->attrs[NL80211_ATTR_PMK])
-- 
2.17.1

