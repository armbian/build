name: PR review labeler
on:
  workflow_run:
    workflows: ["PR review listener"]   # must match the other workflow's name
    types: [completed]

jobs:
  label:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Find PR by commit SHA
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.payload.workflow_run.head_sha;

            const { data: prs } = await github.rest.repos.listPullRequestsAssociatedWithCommit({
              owner,
              repo,
              commit_sha: sha,
            });

            if (!prs.length) {
              core.setFailed(`❌ No PR associated with commit ${sha}`);
              return;
            }

            // Prefer open PRs
            const pr = prs.find(p => p.state === 'open') || prs[0];
            core.info(`✅ Found PR #${pr.number} for commit ${sha}`);
            core.setOutput('number', String(pr.number));

      - name: Label when approved
        if: ${{ success() }}
        uses: j-fulbright/label-when-approved-action@v1.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          label: 'Ready to merge'
          require_committers_approval: 'true'
          remove_label_when_approval_missing: 'true'
          comment: '✅ This PR has been reviewed and approved — all set for merge!'
          pullRequestNumber: ${{ steps.pr.outputs.number }}
