name: build pr kernel
# This workflow is triggered on pushes to the repository.
on: [push, pull_request]

jobs:
  build:
    name: Compile changed kernel
    # This job runs on self hosted Linux machine
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
        with:
          path: build
#          fetch-depth: 1
      - uses: actions/checkout@v2
        with:
          repository: armbian/ci-testing-tools
          path: ci-testing-tools
          fetch-depth: 1
      - uses: actions/checkout@v2
        with:
          repository: slimm609/monorepo-gitwatcher
          path: monorepo-gitwatcher
          fetch-depth: 1
      
#      - run: git checkout HEAD^
#      - name: Get short SHA
#        id: slug
#        run: echo "::set-output name=sha8::$(echo ${GITHUB_SHA} | cut -c1-8)"
#      - name: Get the version
#        id: get_version
#        run: echo "::set-output name=version::${GITHUB_REF#refs/*/}"
      - name: Compile and update repository
        shell: bash         
        run: |  
         GIT_COMMIT=${GITHUB_SHA}
         GIT_PREVIOUS_COMMIT=HEAD
         pwd 
         source ci-testing-tools/jenkins_ci.sh
         
         mkdir -p ${WORKSPACE}/build/userpatches
         cp -f ${WORKSPACE}/ci-testing-tools/config-jenkins-kernel.conf ${WORKSPACE}/build/userpatches/
         
         configure_monorepo_watcher
         generate_board_table
         load_board_table
         
         cd build
         get_files_changed
         get_build_target
         
         git checkout ${GITHUB_SHA}
         git branch -v
         build_kernel jenkins-kernel

