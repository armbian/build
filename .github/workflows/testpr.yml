name: build pr kernel
# This workflow is triggered on pushes to the repository.
on: [pull_request]

jobs:
  build:
    name: Compile changed kernel
    # This job runs on self hosted Linux machine
    runs-on: self-hosted
    steps:
      - uses: rokroskar/workflow-run-cleanup-action@v0.2.2
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0
          path: build
      - uses: actions/checkout@v2
        with:
          repository: armbian/ci-testing-tools
          path: ci-testing-tools
      - uses: actions/checkout@v2
        with:
          repository: slimm609/monorepo-gitwatcher
          path: monorepo-gitwatcher
      
#      - run: git checkout HEAD^
#      - name: Get short SHA
#        id: slug
#        run: echo "::set-output name=sha8::$(echo ${GITHUB_SHA} | cut -c1-8)"
#      - name: Get the version
#        id: get_version
#        run: echo "::set-output name=version::${GITHUB_REF#refs/*/}"
      - name: Compile and update repository
        shell: bash         
        run: |  
         GIT_COMMIT=$GITHUB_SHA
         GIT_PREVIOUS_COMMIT=HEAD
         cd $RUNNER_WORKSPACE/build
         pwd
         find ./ -type d -maxdepth 2
         env
         source ci-testing-tools/jenkins_ci.sh
         
         mkdir -p build/userpatches
         cp -f ci-testing-tools/config-jenkins-kernel.conf build/userpatches/
         configure_monorepo_watcher
         generate_board_table
         load_board_table
         
         cd build
         get_files_changed
         get_build_target
         
         git checkout ${GITHUB_SHA}
         git branch -v
         build_kernel jenkins-kernel

