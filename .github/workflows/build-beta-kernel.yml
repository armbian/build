name: Beta Kernel

on:
  workflow_dispatch:
#  workflow_run:
#    workflows: ["Beta Kernel"]
#    types: [completed]

jobs:

  Merge:
    if: ${{ success() && github.repository_owner == 'Armbian' }}
    uses: armbian/scripts/.github/workflows/merge-from-branch.yml@master

    with:
      branch: 'nightly'

    secrets:
      GPG_KEY2: ${{ secrets.GPG_KEY2 }}
      GPG_PASSPHRASE2: ${{ secrets.GPG_PASSPHRASE2 }}

  Build:
    needs: Merge
    if: ${{ success() && github.repository_owner == 'Armbian' }}
    uses: armbian/scripts/.github/workflows/build-kernel.yml@master

    with:

      uploading: true

    secrets:
      GPG_KEY1: ${{ secrets.GPG_KEY1 }}
      GPG_PASSPHRASE1: ${{ secrets.GPG_PASSPHRASE1 }}
      GPG_KEY2: ${{ secrets.GPG_KEY2 }}
      GPG_PASSPHRASE2: ${{ secrets.GPG_PASSPHRASE2 }}
      SCRIPTS_ACCESS_TOKEN: ${{ secrets.SCRIPTS_ACCESS_TOKEN }}
      KEY_TORRENTS: ${{ secrets.KEY_TORRENTS }}
      KNOWN_HOSTS_UPLOAD: ${{ secrets.KNOWN_HOSTS_UPLOAD }}

  Repository:

    needs: [Merge, Build]
    name: Update stable package repository
    if: ${{ success() && github.repository_owner == 'Armbian' }}
    runs-on: [self-hosted, Linux, local]    
    steps:

      - name: Install SSH key for repository
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.KEY_REPOSITORY }}
          name: id_repository
          known_hosts: ${{ secrets.KNOWN_HOSTS_REPOSITORY }}
          if_key_exists: replace

      - name: Update stable repository
        run: ssh -T -i ~/.ssh/id_repository ${{ secrets.USER_REPOSITORY }}@${{ secrets.HOST_REPOSITORY }}

  Repository-beta:

    name: Update beta package repository
    if: ${{ success() && github.repository_owner == 'Armbian' }}
    runs-on: [self-hosted, Linux, local]    
    steps:

      - name: Install SSH key for repository
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.KEY_REPOSITORY_BETA }}
          name: id_repository_beta
          known_hosts: ${{ secrets.KNOWN_HOSTS_REPOSITORY }}
          if_key_exists: replace

      - name: Update beta repository
