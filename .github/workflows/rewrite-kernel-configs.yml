name: "Sync kernel configs"

# Runs weekly to resync the kernel config baselines.
# If there are any changes, it opens a Pull Request
#
# spdx-id: GPL-2.0-or-later
# copyright-owner: @tabrisnet

on:
  schedule:
  #FIXME: weekly is probably too often, how can we trigger on updates to kernel family definitions?
    - cron: "0 0 * * 0" # weekly
  workflow_dispatch:
    inputs:
      release:
        description: 'Target release'
        required: false
        default: 'bookworm'
        type: choice
        options: #FIXME: do we have another file with these options we could load from?
          - jammy
          - noble
          - bookworm
          - trixie

jobs:
  Build:
    name: "Kernel config syncs"
    runs-on: ubuntu-latest
    env:
      RELEASE: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.release || 'bookworm' }}
    if: ${{ github.repository_owner == 'armbian' }}
    steps:

      - name: "Checkout build repo"
        uses: actions/checkout@v5
        with:
          repository: armbian/build
          ref:  main
          fetch-depth: 0
          clean: false

      - name: "Install SSH key for storage"
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.KEY_UPLOAD }}
          known_hosts: ${{ secrets.KNOWN_HOSTS_ARMBIAN_UPLOAD }}
          if_key_exists: replace

      - name: "run rewrite-kernel-config loop"
        run: tools/rewrite-kernel-configs.sh

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: '`Automatic` kernel configs synchronise'
          signoff: false
          branch: update-kernel-configs
          delete-branch: true
          title: '`Automatic` kernel configs synchronise'
          body: Update kernel config overlays with the most recent kernels

          labels: |
            Work in progress
          #assignees: igorpecovnik
          #reviewers: Must be org collaborator
          draft: false
