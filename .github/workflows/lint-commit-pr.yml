name: Lint Commit Messages
on: [push, pull_request]

jobs:
    commitlint:
        name: "Lint commit"
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Project
              uses: actions/checkout@v3
              with:
                  # for pull_request so we can do HEAD^2
                  fetch-depth: 2

            - name: Get commit message
              id: get_commit_message
              run: |
                  if   [[ '${{ github.event_name }}' == 'push' ]]; then
                    echo "commit_message=$(git log --format=%B -n 1 HEAD)" >> $GITHUB_OUTPUT
                  elif [[ '${{ github.event_name }}' == 'pull_request' ]]; then
                    echo "commit_message=$(git log --format=%B -n 1 HEAD^2)" >> $GITHUB_OUTPUT
                  fi
            - name: "Check latest commit message"
              run: |
                  PATTERN='^Merge.+|(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert|types)(\(.+\))?: .{1,50}'
                  if ! [[ "${{ steps.get_commit_message.outputs.commit_message }}" =~ $PATTERN ]]; then
                     echo
                     echo "  Error: proper commit message format is required for automated changelog generation."
                     echo "  - See .github/COMMIT_CONVENTION.md for more details."
                     echo
                     exit 1
                  fi
