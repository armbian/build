name: Armbian Build

on:
  push:
    paths:
      - 'action.yml'
      - 'config/boards/bananapim2berry.conf'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get upgrade -y
        sudo apt-get dist-upgrade -y;
        sudo apt-get install -y git curl make cmake htop curl wget nano git ruby npm nodejs gcc clang
        sudo apt-get install -y build-essential
        sudo apt-get install -y software-properties-common net-tools traceroute nmap whois etherape
        sudo apt-get install -y bettercap aircrack-ng
        sudo apt-get install python-pip
        sudo apt-get install -y git cmake g++ libboost-all-dev libgmp-dev swig python3-numpy python3-mako python3-sphinx python3-lxml doxygen libfftw3-dev >        sudo apt-get install -y pybind11-dev python3-matplotlib libsndfile1-dev libsoapysdr-dev soapysdr-tools python3-pygccxml python3-pyqtgraph
        sudo apt-get install -y libiio-dev libad9361-dev libspdlog-dev python3-packaging python3-jsonschema python3-qtpy
                sudo apt install python3-matplotlib libsndfile1-dev -y
        sudo add-apt-repository ppa:gnuradio/gnuradio-releases
        sudo apt-get update
        sudo apt-get install -y gnuradio
        sudo apt-get install libraspberrypi-dev -y
        sudo apt-get install sox libsox-fmt-mp3 -y
        sudo apt-get install sox libsox-fmt-mp3 -y


    -name: Installing PIP Packages
     run: |
        sudo pip install pyfm --break-system-packages
        sudo pip install setuptools disutils wheel --break-system-packages
        sudo pip install pyqt6 requests

    -name: Downloading Repositorys
     run: |
       cd /home/pi
       mkdir Entwicklung
       mkdir tmp
       cd tmp
       sudo git clone https://github.com/ChristopheJacquet/PiFmRds
       sudo git clone https://github.com/MundeepL/PiFM.git
       sudo git clone https://github.com/markondej/fm_transmitter.git
       sudo git clone https://github.com/markondej/fm_transmitter
       cd fm_transmitter
       sudo make
       cd ..
       sudo chown pi -hR ./*
       sudo chmod 777 -R ./*
       cd PiFmRds/src
       make clean
       make

    - name: Run Armbian Build
      run: |
        git clone --depth 1 https://github.com/armbian/build
        cd build
        ./compile.sh BOARD=bananapim2berry BRANCH=current RELEASE=bullseye BUILD_MINIMAL=no BUILD_DESKTOP=no KERNEL_ONLY=no KERNEL_CONFIGURE=no

    - name: Auto Commit and Push
      run: |
        chmod +x scripts/auto-commit.sh
        ./scripts/auto-commit.sh
