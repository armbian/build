name: Build beta images

on:
  workflow_dispatch:

jobs:

  Prepare:

    runs-on: [self-hosted, Linux, images]
    if: ${{ github.repository_owner == 'armbian' }}
    steps:
      - name: Checkout repository
          uses: actions/checkout@v2
          with:
            fetch-depth: 0
            repository: armbian/build
            path: build
            ref: nightly
            clean: false

      - name: Cut the job into n chunks
        run: |

          # split into build chunks          
          mkdir -p temp
          cat build/config/targets-cli-beta.conf build/config/targets-desktop-beta.conf | grep -v "^$" | grep -v "^#" | shuf > temp/split.conf
          split -d --number=l/5 --additional-suffix=.conf --suffix-length=1 temp/split.conf temp/split-

      - name: Cache build configurations
        uses: actions/cache@v2
        env:
          cache-name: cache-build
        with:
          path: temp
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_id }}

  Run: # short name because Github will expand with the matrix values

    needs: [ Prepare ]
    runs-on: [self-hosted, Linux, images]
    if: ${{ github.repository_owner == 'armbian' }}
    timeout-minutes: 480
    strategy:
      max-parallel: 10
      fail-fast: false
      matrix: 
        include:
          - part: "00"
          - part: "01"
          - part: "02"
          - part: "03"
          - part: "04"

    steps:
      - name: Cache Gradle packages
        uses: actions/cache@v2
        env:
          cache-name: cache-build
        with:
          path: temp
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_id }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-${{ github.run_id }}

      - name: What's up
        run: |

          set +e
          mkdir -p download
          GITURL="${{ github.repository }}"
          CHUNK="${{ matrix.part }}"
          echo "$GITURL $CHUNK"
          ls -l temp/
